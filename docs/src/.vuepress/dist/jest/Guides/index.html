<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tests instantanés | Test in Javascript</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Testing Vuejs and JS">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.f1075b4d.css" as="style"><link rel="preload" href="/assets/js/app.1dfb11b9.js" as="script"><link rel="preload" href="/assets/js/2.76e9c098.js" as="script"><link rel="preload" href="/assets/js/26.6c0a0e32.js" as="script"><link rel="prefetch" href="/assets/js/10.bd6fd6a5.js"><link rel="prefetch" href="/assets/js/100.e4707484.js"><link rel="prefetch" href="/assets/js/101.e6d01fe0.js"><link rel="prefetch" href="/assets/js/102.03e4577c.js"><link rel="prefetch" href="/assets/js/103.533425bb.js"><link rel="prefetch" href="/assets/js/104.7866060c.js"><link rel="prefetch" href="/assets/js/105.c87ae376.js"><link rel="prefetch" href="/assets/js/106.1470de17.js"><link rel="prefetch" href="/assets/js/107.31d6eb75.js"><link rel="prefetch" href="/assets/js/108.8ab8ef28.js"><link rel="prefetch" href="/assets/js/109.f31541ff.js"><link rel="prefetch" href="/assets/js/11.1abf9ce7.js"><link rel="prefetch" href="/assets/js/110.7b3f1636.js"><link rel="prefetch" href="/assets/js/111.2f2eac6f.js"><link rel="prefetch" href="/assets/js/112.e118dccb.js"><link rel="prefetch" href="/assets/js/113.a8a30aa2.js"><link rel="prefetch" href="/assets/js/114.c9cd627f.js"><link rel="prefetch" href="/assets/js/115.a4796295.js"><link rel="prefetch" href="/assets/js/116.85cb9bc4.js"><link rel="prefetch" href="/assets/js/117.9857c369.js"><link rel="prefetch" href="/assets/js/118.fdd75f70.js"><link rel="prefetch" href="/assets/js/119.480af062.js"><link rel="prefetch" href="/assets/js/12.48bd50ee.js"><link rel="prefetch" href="/assets/js/120.0903be09.js"><link rel="prefetch" href="/assets/js/121.9e357b85.js"><link rel="prefetch" href="/assets/js/122.809a4b0c.js"><link rel="prefetch" href="/assets/js/123.e2038edd.js"><link rel="prefetch" href="/assets/js/124.4af8a9cc.js"><link rel="prefetch" href="/assets/js/125.b77a97ef.js"><link rel="prefetch" href="/assets/js/126.82f59f13.js"><link rel="prefetch" href="/assets/js/127.f41bdaff.js"><link rel="prefetch" href="/assets/js/128.5fca6b14.js"><link rel="prefetch" href="/assets/js/129.59147136.js"><link rel="prefetch" href="/assets/js/13.85e5e853.js"><link rel="prefetch" href="/assets/js/130.01fec4c9.js"><link rel="prefetch" href="/assets/js/131.bf32c3d1.js"><link rel="prefetch" href="/assets/js/132.5072c74e.js"><link rel="prefetch" href="/assets/js/133.e85de282.js"><link rel="prefetch" href="/assets/js/134.402e4e27.js"><link rel="prefetch" href="/assets/js/135.6dd89c1c.js"><link rel="prefetch" href="/assets/js/136.22ed1db4.js"><link rel="prefetch" href="/assets/js/137.72ab073c.js"><link rel="prefetch" href="/assets/js/138.c39958ee.js"><link rel="prefetch" href="/assets/js/139.1aa20bea.js"><link rel="prefetch" href="/assets/js/14.330cbcd9.js"><link rel="prefetch" href="/assets/js/140.c4b7b7a6.js"><link rel="prefetch" href="/assets/js/141.00a6b127.js"><link rel="prefetch" href="/assets/js/142.dc56159a.js"><link rel="prefetch" href="/assets/js/143.56bf7306.js"><link rel="prefetch" href="/assets/js/144.dc28faf5.js"><link rel="prefetch" href="/assets/js/145.58f42865.js"><link rel="prefetch" href="/assets/js/146.cdf5ac64.js"><link rel="prefetch" href="/assets/js/147.55bfcbbc.js"><link rel="prefetch" href="/assets/js/148.80f92bd1.js"><link rel="prefetch" href="/assets/js/149.d769487a.js"><link rel="prefetch" href="/assets/js/15.425a725c.js"><link rel="prefetch" href="/assets/js/150.f7925a0b.js"><link rel="prefetch" href="/assets/js/151.6218c5b9.js"><link rel="prefetch" href="/assets/js/152.41b5cfa0.js"><link rel="prefetch" href="/assets/js/153.05501cee.js"><link rel="prefetch" href="/assets/js/154.e86f3b62.js"><link rel="prefetch" href="/assets/js/155.1c63407d.js"><link rel="prefetch" href="/assets/js/156.c045d5cd.js"><link rel="prefetch" href="/assets/js/157.f6cea34d.js"><link rel="prefetch" href="/assets/js/158.7a808c51.js"><link rel="prefetch" href="/assets/js/159.b3b4561c.js"><link rel="prefetch" href="/assets/js/16.2062fdae.js"><link rel="prefetch" href="/assets/js/160.9d1f6278.js"><link rel="prefetch" href="/assets/js/161.cf4ec401.js"><link rel="prefetch" href="/assets/js/162.0047afe1.js"><link rel="prefetch" href="/assets/js/163.68d2b64d.js"><link rel="prefetch" href="/assets/js/164.ff770c4d.js"><link rel="prefetch" href="/assets/js/165.15d44e1b.js"><link rel="prefetch" href="/assets/js/166.0ffccc31.js"><link rel="prefetch" href="/assets/js/167.74e5cb83.js"><link rel="prefetch" href="/assets/js/168.3e987bc6.js"><link rel="prefetch" href="/assets/js/169.58a1c121.js"><link rel="prefetch" href="/assets/js/17.8ae89c4b.js"><link rel="prefetch" href="/assets/js/170.f5eb4958.js"><link rel="prefetch" href="/assets/js/171.de2ac02b.js"><link rel="prefetch" href="/assets/js/172.e723173f.js"><link rel="prefetch" href="/assets/js/173.ebe3373d.js"><link rel="prefetch" href="/assets/js/174.754bc705.js"><link rel="prefetch" href="/assets/js/175.68256c4c.js"><link rel="prefetch" href="/assets/js/176.0f54fcc6.js"><link rel="prefetch" href="/assets/js/177.eca24763.js"><link rel="prefetch" href="/assets/js/178.a53fc0b4.js"><link rel="prefetch" href="/assets/js/179.76c93623.js"><link rel="prefetch" href="/assets/js/18.2d051dd7.js"><link rel="prefetch" href="/assets/js/180.89a3951a.js"><link rel="prefetch" href="/assets/js/181.5545787b.js"><link rel="prefetch" href="/assets/js/182.44e30a17.js"><link rel="prefetch" href="/assets/js/183.98f27b20.js"><link rel="prefetch" href="/assets/js/184.8440af44.js"><link rel="prefetch" href="/assets/js/185.000aeddf.js"><link rel="prefetch" href="/assets/js/186.d6b8251b.js"><link rel="prefetch" href="/assets/js/187.31fa426e.js"><link rel="prefetch" href="/assets/js/188.58ccf322.js"><link rel="prefetch" href="/assets/js/189.c2ecd64b.js"><link rel="prefetch" href="/assets/js/19.7680ca75.js"><link rel="prefetch" href="/assets/js/190.6585dda4.js"><link rel="prefetch" href="/assets/js/191.ac09d6be.js"><link rel="prefetch" href="/assets/js/192.569eadde.js"><link rel="prefetch" href="/assets/js/193.dbc5d0c3.js"><link rel="prefetch" href="/assets/js/194.1ed49f10.js"><link rel="prefetch" href="/assets/js/195.73d17c86.js"><link rel="prefetch" href="/assets/js/196.38585136.js"><link rel="prefetch" href="/assets/js/197.80be5379.js"><link rel="prefetch" href="/assets/js/198.d2983630.js"><link rel="prefetch" href="/assets/js/199.c5b0eaae.js"><link rel="prefetch" href="/assets/js/20.92722f5a.js"><link rel="prefetch" href="/assets/js/200.d293a5ee.js"><link rel="prefetch" href="/assets/js/201.845153bc.js"><link rel="prefetch" href="/assets/js/202.c1a3aeac.js"><link rel="prefetch" href="/assets/js/203.fe05addc.js"><link rel="prefetch" href="/assets/js/21.be6446d5.js"><link rel="prefetch" href="/assets/js/22.68cd31e9.js"><link rel="prefetch" href="/assets/js/23.bdf61bc1.js"><link rel="prefetch" href="/assets/js/24.53cdec02.js"><link rel="prefetch" href="/assets/js/25.ebc52990.js"><link rel="prefetch" href="/assets/js/27.47a1acf9.js"><link rel="prefetch" href="/assets/js/28.9325d706.js"><link rel="prefetch" href="/assets/js/29.5805cc76.js"><link rel="prefetch" href="/assets/js/3.55e527b8.js"><link rel="prefetch" href="/assets/js/30.c432e70c.js"><link rel="prefetch" href="/assets/js/31.3b720485.js"><link rel="prefetch" href="/assets/js/32.8badbdd6.js"><link rel="prefetch" href="/assets/js/33.748d0532.js"><link rel="prefetch" href="/assets/js/34.c3eda56a.js"><link rel="prefetch" href="/assets/js/35.71847246.js"><link rel="prefetch" href="/assets/js/36.0611c91e.js"><link rel="prefetch" href="/assets/js/37.ba71a4af.js"><link rel="prefetch" href="/assets/js/38.ac6f30d4.js"><link rel="prefetch" href="/assets/js/39.58ba7a9e.js"><link rel="prefetch" href="/assets/js/4.bf905f50.js"><link rel="prefetch" href="/assets/js/40.26590aff.js"><link rel="prefetch" href="/assets/js/41.694f8d58.js"><link rel="prefetch" href="/assets/js/42.2d7d8d44.js"><link rel="prefetch" href="/assets/js/43.9cec6759.js"><link rel="prefetch" href="/assets/js/44.f7719b56.js"><link rel="prefetch" href="/assets/js/45.939a097b.js"><link rel="prefetch" href="/assets/js/46.9eb035b4.js"><link rel="prefetch" href="/assets/js/47.717699f5.js"><link rel="prefetch" href="/assets/js/48.e2a83d9e.js"><link rel="prefetch" href="/assets/js/49.0f4a38a5.js"><link rel="prefetch" href="/assets/js/5.44066470.js"><link rel="prefetch" href="/assets/js/50.09b9cedf.js"><link rel="prefetch" href="/assets/js/51.ca236e5a.js"><link rel="prefetch" href="/assets/js/52.8ab1dd65.js"><link rel="prefetch" href="/assets/js/53.4950b2fa.js"><link rel="prefetch" href="/assets/js/54.6c28a1ae.js"><link rel="prefetch" href="/assets/js/55.203bfda1.js"><link rel="prefetch" href="/assets/js/56.feea9280.js"><link rel="prefetch" href="/assets/js/57.bbd935c4.js"><link rel="prefetch" href="/assets/js/58.98b7e31b.js"><link rel="prefetch" href="/assets/js/59.11977924.js"><link rel="prefetch" href="/assets/js/6.ffe6f60a.js"><link rel="prefetch" href="/assets/js/60.fef4549b.js"><link rel="prefetch" href="/assets/js/61.5cac46d9.js"><link rel="prefetch" href="/assets/js/62.96cd90d5.js"><link rel="prefetch" href="/assets/js/63.66c5a79a.js"><link rel="prefetch" href="/assets/js/64.57532410.js"><link rel="prefetch" href="/assets/js/65.d081c48d.js"><link rel="prefetch" href="/assets/js/66.cfb836a0.js"><link rel="prefetch" href="/assets/js/67.7b4dd45f.js"><link rel="prefetch" href="/assets/js/68.e7ebbee9.js"><link rel="prefetch" href="/assets/js/69.68324175.js"><link rel="prefetch" href="/assets/js/7.a00e933e.js"><link rel="prefetch" href="/assets/js/70.27518c57.js"><link rel="prefetch" href="/assets/js/71.7a58fc57.js"><link rel="prefetch" href="/assets/js/72.08c01f3b.js"><link rel="prefetch" href="/assets/js/73.1d2fa4b2.js"><link rel="prefetch" href="/assets/js/74.a06f107c.js"><link rel="prefetch" href="/assets/js/75.ac9e2bd1.js"><link rel="prefetch" href="/assets/js/76.899208f6.js"><link rel="prefetch" href="/assets/js/77.0f1d0c65.js"><link rel="prefetch" href="/assets/js/78.8a73a4c3.js"><link rel="prefetch" href="/assets/js/79.e2db69cb.js"><link rel="prefetch" href="/assets/js/8.d194c183.js"><link rel="prefetch" href="/assets/js/80.b61d7063.js"><link rel="prefetch" href="/assets/js/81.a82b5e62.js"><link rel="prefetch" href="/assets/js/82.9a5b8058.js"><link rel="prefetch" href="/assets/js/83.10352c38.js"><link rel="prefetch" href="/assets/js/84.ccacae49.js"><link rel="prefetch" href="/assets/js/85.ee9987ed.js"><link rel="prefetch" href="/assets/js/86.f89fad1c.js"><link rel="prefetch" href="/assets/js/87.44e47fe2.js"><link rel="prefetch" href="/assets/js/88.94dfbf30.js"><link rel="prefetch" href="/assets/js/89.04227930.js"><link rel="prefetch" href="/assets/js/9.2250d602.js"><link rel="prefetch" href="/assets/js/90.7a82ea28.js"><link rel="prefetch" href="/assets/js/91.4a625cbe.js"><link rel="prefetch" href="/assets/js/92.29d2fcc3.js"><link rel="prefetch" href="/assets/js/93.3223892e.js"><link rel="prefetch" href="/assets/js/94.7584ac0d.js"><link rel="prefetch" href="/assets/js/95.75db5c06.js"><link rel="prefetch" href="/assets/js/96.bf62c5a6.js"><link rel="prefetch" href="/assets/js/97.66fdd036.js"><link rel="prefetch" href="/assets/js/98.c9d329be.js"><link rel="prefetch" href="/assets/js/99.b6f9c026.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f1075b4d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Test in Javascript</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vue-test-utils/" class="nav-link">
  Vue-Test-Utils
</a></div><div class="nav-item"><a href="/vue-testing-handbook/" class="nav-link">
  Le manuel de lmiller1990
</a></div><div class="nav-item"><a href="/jest/" class="nav-link router-link-active">
  Jest
</a></div><div class="nav-item"><a href="/mocha/" class="nav-link">
  Mocha
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vue-test-utils/" class="nav-link">
  Vue-Test-Utils
</a></div><div class="nav-item"><a href="/vue-testing-handbook/" class="nav-link">
  Le manuel de lmiller1990
</a></div><div class="nav-item"><a href="/jest/" class="nav-link router-link-active">
  Jest
</a></div><div class="nav-item"><a href="/mocha/" class="nav-link">
  Mocha
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Jest</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jest/" aria-current="page" class="sidebar-link">Jest</a></li><li><a href="/jest/introduction.html" class="sidebar-link">Pour commencer</a></li><li><a href="/jest/guides.html" class="sidebar-link">Tests instantanés</a></li><li><a href="/jest/framework.html" class="sidebar-link">Tester les Apps React</a></li><li><a href="/jest/api.html" class="sidebar-link">Les api générales</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tests-instantanes"><a href="#tests-instantanes" class="header-anchor">#</a> Tests instantanés</h1> <p>Les tests instantanés sont un outil très utile lorsque vous voulez vous assurer que votre UI ne change pas de manière inattendue.</p> <p>Un scénario de test snapshot typique rend un composant de l'interface utilisateur, prend un instantané, puis le compare à un fichier snapshot de référence stocké à côté du test. Le test échouera si les deux instantanés ne correspondent pas : soit le changement est inattendu, soit l'instantané de référence doit être mis à jour avec la nouvelle version du composant de l'interface utilisateur.</p> <h2 id="test-instantane-avec-jest"><a href="#test-instantane-avec-jest" class="header-anchor">#</a> Test instantané avec Jest</h2> <p>Une approche similaire peut être adoptée lorsqu'il s'agit de tester vos composants React. Au lieu de rendre l'interface graphique, ce qui nécessiterait de construire l'application entière, vous pouvez utiliser un moteur de rendu de test pour générer rapidement une valeur sérialisable pour votre arbre React. Considérez ce <a href="https://github.com/facebook/jest/blob/master/examples/snapshot/__tests__/link.react.test.js" target="_blank" rel="noopener noreferrer">exemple de test<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> pour un <a href="https://github.com/facebook/jest/blob/master/examples/snapshot/Link.react.js" target="_blank" rel="noopener noreferrer">composant de lien<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Link <span class="token keyword">from</span> <span class="token string">'../Link.react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> renderer <span class="token keyword">from</span> <span class="token string">'react-test-renderer'</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'renders correctly'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> tree <span class="token operator">=</span> renderer
    <span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Link page<span class="token operator">=</span><span class="token string">&quot;http://www.facebook.com&quot;</span><span class="token operator">&gt;</span>Facebook<span class="token operator">&lt;</span><span class="token operator">/</span>Link<span class="token operator">&gt;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>La première fois que ce test est effectué, Jest crée un [fichier instantané] (https://github.com/facebook/jest/blob/master/examples/snapshot/<strong>tests</strong>/<strong>snapshots</strong>/link.react.test.js.snap) qui ressemble à ceci :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>exports<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">renders correctly 1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
&lt;a
  className=&quot;normal&quot;
  href=&quot;http://www.facebook.com&quot;
  onMouseEnter={[Function]}
  onMouseLeave={[Function]}
&gt;
  Facebook
&lt;/a&gt;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre></div><p>L'artefact instantané doit être commis en même temps que les changements de code, et examiné dans le cadre de votre processus de révision du code. Jest utilise [pretty-format] (https://github.com/facebook/jest/tree/master/packages/pretty-format) pour rendre les instantanés lisibles par l'homme pendant la révision du code. Lors des tests suivants, Jest compare la sortie rendue avec l'instantané précédent. S'ils correspondent, le test sera réussi. S'ils ne correspondent pas, soit le testeur a trouvé un bug dans votre code (dans ce cas, c'est le composant <code>&lt;Link&gt;</code>) qui doit être corrigé, soit l'implémentation a changé et l'instantané doit être mis à jour.</p> <blockquote><p>Note : L'instantané est directement lié aux données que vous rendez - dans notre exemple, il s'agit du composant <code>&lt;Link /&gt;</code> avec le page prop qui lui est passé. Cela implique que même si un autre fichier a des accessoires manquants (disons, <code>App.js</code>) dans le composant <code>&lt;Link /&gt;</code>, il passera quand même le test car le test ne connaît pas l'utilisation du composant <code>&lt;Link /&gt;</code> et il est seulement limité au composant <code>Link.react.js</code>. De plus, rendre le même composant avec des accessoires différents dans d'autres tests d'instantanés n'affectera pas le premier, car les tests ne se connaissent pas entre eux.</p></blockquote> <p>Vous trouverez plus d'informations sur le fonctionnement des tests instantanés et sur la raison pour laquelle nous les avons mis en place sur le [release blog post] (https://jestjs.io/blog/2016/07/27/jest-14.html). Nous vous recommandons de lire [ce billet] (http://benmccormick.org/2016/09/19/testing-with-jest-snapshots-first-impressions/) pour avoir une bonne idée du moment où vous devriez utiliser les tests d'instantanés. Nous vous recommandons également de regarder cette [vidéo egghead] (https://egghead.io/lessons/javascript-use-jest-s-snapshot-testing-feature?pl=testing-javascript-with-jest-a36c4074) sur le test instantané avec Jest.</p> <h3 id="mise-a-jour-des-instantanes"><a href="#mise-a-jour-des-instantanes" class="header-anchor">#</a> Mise à jour des instantanés</h3> <p>Il est facile de repérer quand un test instantané échoue après l'introduction d'un bug. Lorsque cela se produit, corrigez le problème et assurez-vous que vos tests instantanés sont à nouveau réussis. Maintenant, parlons du cas où un test instantané échoue à cause d'un changement intentionnel de l'implémentation.</p> <p>Une telle situation peut se produire si nous modifions intentionnellement l'adresse vers laquelle le composant Link de notre exemple pointe.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Cas test mis à jour avec un lien vers une adresse différente</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'renders correctly'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> tree <span class="token operator">=</span> renderer
    <span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Link page<span class="token operator">=</span><span class="token string">&quot;http://www.instagram.com&quot;</span><span class="token operator">&gt;</span>Instagram<span class="token operator">&lt;</span><span class="token operator">/</span>Link<span class="token operator">&gt;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Dans ce cas, Jest imprimera cette sortie :</p> <p><img src="/img/content/failedSnapshotTest.png" alt=""></p> <p>Comme nous venons de mettre à jour notre composant pour qu'il pointe vers une adresse différente, il est raisonnable de s'attendre à des changements dans l'instantané de ce composant. Notre scénario de test de l'instantané échoue parce que l'instantané de notre composant mis à jour ne correspond plus à l'artefact de l'instantané de ce scénario de test.</p> <p>Pour résoudre ce problème, nous devrons mettre à jour nos artefacts d'instantané. Vous pouvez lancer Jest avec un drapeau qui lui indiquera de générer à nouveau des instantanés :</p> <div class="language-bash extra-class"><pre class="language-bash"><code>jest --updateSnapshot
</code></pre></div><p>Allez-y et acceptez les changements en exécutant la commande ci-dessus. Vous pouvez également utiliser l'équivalent du drapeau <code>-u</code> à un seul caractère pour générer à nouveau des instantanés si vous préférez. Cela permettra de générer à nouveau des artefacts d'instantanés pour tous les tests d'instantanés qui échouent. Si nous avions d'autres échecs de tests d'instantanés à cause d'un bug involontaire, nous aurions besoin de corriger le bug avant de re-générer des instantanés pour éviter d'enregistrer des instantanés du comportement bogué.</p> <p>Si vous souhaitez limiter les cas de tests snapshot à re-générer, vous pouvez passer un drapeau supplémentaire <code>--testNamePattern</code> pour ne ré-enregistrer des snapshots que pour les tests qui correspondent au pattern.</p> <p>Vous pouvez tester cette fonctionnalité en clonant le [snapshot example] (https://github.com/facebook/jest/tree/master/examples/snapshot), en modifiant le composant &quot;Link&quot; et en lançant Jest.</p> <h3 id="mode-instantane-interactif"><a href="#mode-instantane-interactif" class="header-anchor">#</a> Mode instantané interactif</h3> <p>Les clichés ratés peuvent également être mis à jour de manière interactive en mode veille :</p> <p><img src="/img/content/interactiveSnapshot.png" alt=""></p> <p>Une fois que vous entrez dans le mode instantané interactif, Jest vous fera passer les instantanés ratés un test à la fois et vous donnera la possibilité de revoir les résultats ratés.</p> <p>De là, vous pouvez choisir de mettre à jour cet instantané ou de passer au suivant :</p> <p><img src="/img/content/interactiveSnapshotUpdate.gif" alt=""></p> <p>Une fois que vous aurez terminé, Jest vous donnera un résumé avant de revenir au mode de surveillance :</p> <p><img src="/img/content/interactiveSnapshotDone.png" alt=""></p> <h3 id="instantanes-en-ligne"><a href="#instantanes-en-ligne" class="header-anchor">#</a> Instantanés en ligne</h3> <p>Les instantanés en ligne se comportent de manière identique aux instantanés externes (fichiers &quot;snap&quot;), sauf que les valeurs des instantanés sont automatiquement réécrites dans le code source. Cela signifie que vous pouvez bénéficier des avantages des instantanés générés automatiquement sans avoir à passer à un fichier externe pour vous assurer que la bonne valeur a été écrite.</p> <blockquote><p>Les photos en ligne sont alimentées par [Prettier] (https://prettier.io). Pour utiliser les instantanés en ligne, vous devez avoir installé <code>prettier</code> dans votre projet. Votre configuration Prettier sera respectée lors de l'écriture des fichiers de test.</p> <p>Si vous avez installé <code>prettier</code> dans un endroit où Jest ne peut pas le trouver, vous pouvez lui dire comment le trouver en utilisant la propriété de configuration <a href="/jest/Guides/Configuration.html#prettierpath-string"><code>&quot;prettierPath&quot;</code></a>.</p></blockquote> <p><strong>Exemple :</strong></p> <p>D'abord, vous écrirez un test, en appelant <code>.toMatchInlineSnapshot()</code> sans arguments :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'renders correctly'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> tree <span class="token operator">=</span> renderer
    <span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Link page<span class="token operator">=</span><span class="token string">&quot;https://prettier.io&quot;</span><span class="token operator">&gt;</span>Prettier<span class="token operator">&lt;</span><span class="token operator">/</span>Link<span class="token operator">&gt;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchInlineSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>La prochaine fois que vous lancerez Jest, <code>tree</code> sera évalué, et un snapshot sera écrit en argument de <code>toMatchInlineSnapshot</code> :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'renders correctly'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> tree <span class="token operator">=</span> renderer
    <span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Link page<span class="token operator">=</span><span class="token string">&quot;https://prettier.io&quot;</span><span class="token operator">&gt;</span>Prettier<span class="token operator">&lt;</span><span class="token operator">/</span>Link<span class="token operator">&gt;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchInlineSnapshot</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
&lt;a
  className=&quot;normal&quot;
  href=&quot;https://prettier.io&quot;
  onMouseEnter={[Function]}
  onMouseLeave={[Function]}
&gt;
  Prettier
&lt;/a&gt;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>C'est tout ce qu'il y a à faire ! Vous pouvez même mettre à jour les snapshots avec <code>--updateSnapshot</code> ou en utilisant la touche <code>u</code> en mode <code>--watch</code>.</p> <h3 id="les-matchers-de-propriete"><a href="#les-matchers-de-propriete" class="header-anchor">#</a> Les matchers de propriété</h3> <p>Souvent, l'objet que vous souhaitez photographier comporte des champs qui sont générés (comme les ID et les dates). Si vous essayez de prendre un instantané de ces objets, ils forceront l'instantané à échouer à chaque exécution :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'will fail every time'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
    createdAt<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    id<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">'LeBron James'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Snapshot</span>
exports<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">will fail every time 1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
Object {
  &quot;createdAt&quot;: 2018-05-19T23:36:09.816Z,
  &quot;id&quot;: 3,
  &quot;name&quot;: &quot;LeBron James&quot;,
}
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre></div><p>Pour ces cas, Jest permet de fournir un appariement asymétrique pour n'importe quel bien. Ces correspondances sont vérifiées avant que l'instantané ne soit écrit ou testé, puis enregistrées dans le fichier de l'instantané au lieu de la valeur reçue :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'will check the matchers and pass'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
    createdAt<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    id<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">'LeBron James'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    createdAt<span class="token operator">:</span> expect<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span>Date<span class="token punctuation">)</span><span class="token punctuation">,</span>
    id<span class="token operator">:</span> expect<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span>Number<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Snapshot</span>
exports<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">will check the matchers and pass 1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
Object {
  &quot;createdAt&quot;: Any&lt;Date&gt;,
  &quot;id&quot;: Any&lt;Number&gt;,
  &quot;name&quot;: &quot;LeBron James&quot;,
}
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre></div><p>Toute valeur donnée qui n'est pas une correspondance sera vérifiée exactement et enregistrée dans l'instantané :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'will check the values and pass'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
    createdAt<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">'Bond... James Bond'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    createdAt<span class="token operator">:</span> expect<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span>Date<span class="token punctuation">)</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">'Bond... James Bond'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Snapshot</span>
exports<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">will check the values and pass 1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
Object {
  &quot;createdAt&quot;: Any&lt;Date&gt;,
  &quot;name&quot;: 'Bond... James Bond',
}
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre></div><h2 id="meilleures-pratiques"><a href="#meilleures-pratiques" class="header-anchor">#</a> Meilleures pratiques</h2> <p>Les instantanés sont un outil fantastique pour identifier les changements d'interface inattendus au sein de votre application - que cette interface soit une réponse API, une interface utilisateur, des journaux ou des messages d'erreur. Comme pour toute stratégie de test, il existe des bonnes pratiques que vous devez connaître et des directives que vous devez suivre pour les utiliser efficacement.</p> <h3 id="_1-traiter-les-instantanes-comme-du-code"><a href="#_1-traiter-les-instantanes-comme-du-code" class="header-anchor">#</a> 1. Traiter les instantanés comme du code</h3> <p>Faites des instantanés et examinez-les dans le cadre de votre processus régulier de révision du code. Cela signifie que vous devez traiter les instantanés comme n'importe quel autre type de test ou de code dans votre projet.</p> <p>Assurez-vous que vos instantanés sont lisibles en les gardant concentrés, courts, et en utilisant des outils qui font respecter ces conventions stylistiques.</p> <p>Comme mentionné précédemment, Jest utilise <a href="https://yarnpkg.com/en/package/pretty-format" target="_blank" rel="noopener noreferrer"><code>pretty-format</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> pour rendre les instantanés lisibles par l'homme, mais vous pouvez trouver utile d'introduire des outils supplémentaires, comme <a href="https://yarnpkg.com/en/package/eslint-plugin-jest" target="_blank" rel="noopener noreferrer"><code>eslint-plugin-jest</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> avec son option <a href="https://github.com/jest-community/eslint-plugin-jest/blob/master/docs/rules/no-large-snapshots.md" target="_blank" rel="noopener noreferrer"><code>no-large-snapshots</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, ou <a href="https://yarnpkg.com/en/package/snapshot-diff" target="_blank" rel="noopener noreferrer"><code>snapshot-diff</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> avec sa fonction de comparaison d'instantanés de composants, afin de promouvoir des affirmations courtes et ciblées.</p> <p>L'objectif est de faciliter l'examen des instantanés dans les requêtes pull, et de lutter contre l'habitude de régénérer les instantanés lorsque les suites de test échouent au lieu d'examiner les causes profondes de leur échec.</p> <h3 id="_2-les-tests-doivent-etre-deterministes"><a href="#_2-les-tests-doivent-etre-deterministes" class="header-anchor">#</a> 2. Les tests doivent être déterministes</h3> <p>Vos tests doivent être déterministes. Exécuter les mêmes tests plusieurs fois sur un composant qui n'a pas changé devrait produire les mêmes résultats à chaque fois. Vous devez vous assurer que les instantanés générés ne contiennent pas de données spécifiques à la plate-forme ou d'autres données non déterministes.</p> <p>Par exemple, si vous avez un composant <a href="https://github.com/facebook/jest/blob/master/examples/snapshot/Clock.react.js" target="_blank" rel="noopener noreferrer">Clock<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> qui utilise <code>Date.now()</code>, l'instantané généré par ce composant sera différent à chaque fois que le scénario de test sera exécuté. Dans ce cas, nous pouvons <a href="/jest/Guides/MockFunctions.html">simuler la méthode Date.now()</a> pour renvoyer une valeur cohérente à chaque fois que le test est exécuté :</p> <div class="language-js extra-class"><pre class="language-js"><code>Date<span class="token punctuation">.</span>now <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">1482363367071</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Maintenant, à chaque fois que le scénario de test de l'instantané est exécuté, <code>Date.now()</code> renverra <code>1482363367071</code> de manière cohérente. Cela aura pour conséquence de générer le même instantané pour ce composant, quel que soit le moment où le test est exécuté.</p> <h3 id="_3-utiliser-des-noms-d-instantanes-descriptifs"><a href="#_3-utiliser-des-noms-d-instantanes-descriptifs" class="header-anchor">#</a> 3. Utiliser des noms d'instantanés descriptifs</h3> <p>Essayez toujours d'utiliser des noms de tests descriptifs et/ou de clichés pour les instantanés. Les meilleurs noms décrivent le contenu attendu de l'instantané. Il est ainsi plus facile pour les examinateurs de vérifier les instantanés pendant l'examen, et pour quiconque de savoir si un instantané périmé est ou non le bon comportement avant la mise à jour.</p> <p>Par exemple, comparer :</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;UserName /&gt; should handle some test case</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">null</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

exports<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;UserName /&gt; should handle some other test case</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
&lt;div&gt;
  Alan Turing
&lt;/div&gt;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre></div><p>A L'adresse suivante :</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;UserName /&gt; should render null</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">null</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

exports<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;UserName /&gt; should render Alan Turing</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
&lt;div&gt;
  Alan Turing
&lt;/div&gt;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre></div><p>Comme ce dernier décrit exactement ce qui est attendu dans le résultat, il est plus clair de voir quand il est erroné :</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;UserName /&gt; should render null</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
&lt;div&gt;
  Alan Turing
&lt;/div&gt;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

exports<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;UserName /&gt; should render Alan Turing</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">null</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre></div><h2 id="foire-aux-questions"><a href="#foire-aux-questions" class="header-anchor">#</a> Foire aux questions</h2> <h3 id="les-instantanes-sont-ils-ecrits-automatiquement-sur-les-systemes-d-integration-continue-ic"><a href="#les-instantanes-sont-ils-ecrits-automatiquement-sur-les-systemes-d-integration-continue-ic" class="header-anchor">#</a> Les instantanés sont-ils écrits automatiquement sur les systèmes d'intégration continue (IC) ?</h3> <p>Non, à partir de Jest 20, les snapshots dans Jest ne sont pas automatiquement écrits lorsque Jest est exécuté dans un système de CI sans passer explicitement par <code>--updateSnapshot</code>. On s'attend à ce que tous les snapshots fassent partie du code qui est exécuté sur le CI et comme les nouveaux snapshots passent automatiquement, ils ne devraient pas passer un test sur un système de CI. Il est recommandé de toujours valider tous les instantanés et de les garder sous contrôle de version.</p> <h3 id="faut-il-commettre-des-instantanes"><a href="#faut-il-commettre-des-instantanes" class="header-anchor">#</a> Faut-il commettre des instantanés ?</h3> <p>Oui, tous les fichiers d'instantanés doivent être validés en même temps que les modules qu'ils couvrent et leurs tests. Ils doivent être considérés comme faisant partie d'un test, tout comme la valeur de toute autre affirmation dans Jest. En fait, les instantanés représentent l'état des modules sources à un moment donné. De cette façon, lorsque les modules sources sont modifiés, Jest peut dire ce qui a changé par rapport à la version précédente. Il peut également fournir beaucoup de contexte supplémentaire pendant la révision du code, dans lequel les réviseurs peuvent mieux étudier vos changements.</p> <h3 id="est-ce-que-les-tests-instantanes-ne-fonctionnent-qu-avec-les-composants-react"><a href="#est-ce-que-les-tests-instantanes-ne-fonctionnent-qu-avec-les-composants-react" class="header-anchor">#</a> Est-ce que les tests instantanés ne fonctionnent qu'avec les composants React ?</h3> <p>Les composants <a href="/jest/Guides/TutorialReact.html">React</a> et <a href="/jest/Guides/TutorialReactNative.html">React Native</a> sont un bon cas d'utilisation pour les tests d'instantanés. Cependant, les instantanés peuvent capturer n'importe quelle valeur sérialisable et doivent être utilisés chaque fois que l'objectif est de tester si la sortie est correcte. Le dépôt Jest contient de nombreux exemples de test de la sortie de Jest lui-même, de la sortie de la bibliothèque d'assertions de Jest ainsi que des messages de log de diverses parties de la base de code de Jest. Voir un exemple de <a href="https://github.com/facebook/jest/blob/master/e2e/__tests__/console.test.ts" target="_blank" rel="noopener noreferrer">snapshotting CLI output<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> dans le dépôt Jest.</p> <h3 id="quelle-est-la-difference-entre-un-test-d-instantane-et-un-test-de-regression-visuelle"><a href="#quelle-est-la-difference-entre-un-test-d-instantane-et-un-test-de-regression-visuelle" class="header-anchor">#</a> Quelle est la différence entre un test d'instantané et un test de régression visuelle ?</h3> <p>Les tests instantanés et les tests de régression visuelle sont deux moyens distincts de tester les interfaces utilisateur, et ils servent des objectifs différents. Les outils de test de régression visuelle prennent des captures d'écran de pages web et comparent les images résultantes pixel par pixel. Avec le test Snapshot, les valeurs sont sérialisées, stockées dans des fichiers texte et comparées à l'aide d'un algorithme de diffraction. Il y a différents compromis à considérer et nous avons énuméré les raisons pour lesquelles les tests instantanés ont été construits dans le [Jest blog] (https://jestjs.io/blog/2016/07/27/jest-14.html#why-snapshot-testing).</p> <h3 id="les-tests-instantanes-remplacent-ils-les-tests-unitaires"><a href="#les-tests-instantanes-remplacent-ils-les-tests-unitaires" class="header-anchor">#</a> Les tests instantanés remplacent-ils les tests unitaires ?</h3> <p>Le test instantané n'est qu'une des 20 affirmations qui accompagnent Jest. L'objectif des tests instantanés n'est pas de remplacer les tests unitaires existants, mais d'apporter une valeur ajoutée et de rendre les tests indolores. Dans certains scénarios, les tests instantanés peuvent potentiellement supprimer la nécessité de tests unitaires pour un ensemble particulier de fonctionnalités (par exemple, les composants de réaction), mais ils peuvent également fonctionner ensemble.</p> <h3 id="quelles-sont-les-performances-des-tests-d-instantanes-en-ce-qui-concerne-la-vitesse-et-la-taille-des-fichiers-generes"><a href="#quelles-sont-les-performances-des-tests-d-instantanes-en-ce-qui-concerne-la-vitesse-et-la-taille-des-fichiers-generes" class="header-anchor">#</a> Quelles sont les performances des tests d'instantanés en ce qui concerne la vitesse et la taille des fichiers générés ?</h3> <p>Jest a été réécrit dans un souci de performance, et les tests d'instantanés ne font pas exception. Comme les instantanés sont stockés dans des fichiers texte, cette méthode de test est rapide et fiable. Jest génère un nouveau fichier pour chaque fichier de test qui invoque le &quot;MatchSnapshot&quot;. La taille des snapshots est assez petite : Pour référence, la taille de tous les fichiers d'instantanés dans la base de code de Jest elle-même est inférieure à 300 Ko.</p> <h3 id="comment-resoudre-les-conflits-dans-les-fichiers-d-instantanes"><a href="#comment-resoudre-les-conflits-dans-les-fichiers-d-instantanes" class="header-anchor">#</a> Comment résoudre les conflits dans les fichiers d'instantanés ?</h3> <p>Les fichiers d'instantanés doivent toujours représenter l'état actuel des modules qu'ils couvrent. Par conséquent, si vous fusionnez deux branches et que vous rencontrez un conflit dans les fichiers d'instantanés, vous pouvez soit résoudre le conflit manuellement, soit mettre à jour le fichier d'instantanés en exécutant Jest et en inspectant le résultat.</p> <h3 id="est-il-possible-d-appliquer-les-principes-de-developpement-pilote-par-les-tests-avec-des-tests-instantanes"><a href="#est-il-possible-d-appliquer-les-principes-de-developpement-pilote-par-les-tests-avec-des-tests-instantanes" class="header-anchor">#</a> Est-il possible d'appliquer les principes de développement piloté par les tests avec des tests instantanés ?</h3> <p>Bien qu'il soit possible d'écrire des fichiers d'instantanés manuellement, cela n'est généralement pas envisageable. Les instantanés aident à déterminer si la sortie des modules couverts par les tests est modifiée, plutôt que de donner des conseils pour concevoir le code en premier lieu.</p> <h3 id="la-couverture-de-code-fonctionne-t-elle-avec-les-tests-instantanes"><a href="#la-couverture-de-code-fonctionne-t-elle-avec-les-tests-instantanes" class="header-anchor">#</a> La couverture de code fonctionne-t-elle avec les tests instantanés ?</h3> <p>Oui, ainsi qu'avec tout autre test.</p> <h1 id="un-exemple-d-asynchronisation"><a href="#un-exemple-d-asynchronisation" class="header-anchor">#</a> Un exemple d'asynchronisation</h1> <p>Tout d'abord, activez le support Babel dans Jest comme indiqué dans le guide <a href="/jest/Guides/GettingStarted.html#using-babel">Getting Started</a>.</p> <p>Mettons en place un module qui récupère les données de l'utilisateur à partir d'une API et renvoie le nom de l'utilisateur.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// user.js</span>
<span class="token keyword">import</span> request <span class="token keyword">from</span> <span class="token string">'./request'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token parameter">userID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">'/users/'</span> <span class="token operator">+</span> userID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=&gt;</span> user<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Dans la mise en œuvre ci-dessus, nous attendons du module &quot;request.js&quot; qu'il nous rende une promesse. Nous enchaînons un appel à <code>then</code> pour recevoir le nom d'utilisateur.</p> <p>Imaginez maintenant une implémentation de <code>request.js</code> qui va sur le réseau et récupère quelques données utilisateur :</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// request.js</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Ceci est un exemple de requête http, par exemple pour aller chercher</span>
    <span class="token comment">// les données d'utilisateur d'une API.</span>
    <span class="token comment">// Ce module est simulé dans __mocks__/request.js</span>
    http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span>path<span class="token operator">:</span> url<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      response<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">_data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>data <span class="token operator">+=</span> _data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      response<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Comme nous ne voulons pas aller sur le réseau dans notre test, nous allons créer une simulation manuelle pour notre module <code>request.js</code> dans le dossier <code>__mocks__</code> (le dossier est sensible à la casse, <code>__MOCKS__</code> ne fonctionnera pas). Cela pourrait ressembler à quelque chose comme ça :</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// __mocks__/request.js</span>
<span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token number">4</span><span class="token operator">:</span> <span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'Mark'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token number">5</span><span class="token operator">:</span> <span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'Paul'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> userID <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token string">'/users/'</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      users<span class="token punctuation">[</span>userID<span class="token punctuation">]</span>
        <span class="token operator">?</span> <span class="token function">resolve</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>userID<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            error<span class="token operator">:</span> <span class="token string">'User with '</span> <span class="token operator">+</span> userID <span class="token operator">+</span> <span class="token string">' not found.'</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Maintenant, faisons un test pour notre fonctionnalité d'asynchronisation.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// __tests__/user-test.js</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'../request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> user <span class="token keyword">from</span> <span class="token string">'../user'</span><span class="token punctuation">;</span>

<span class="token comment">// L'affirmation pour une promesse doit être retournée.</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'works with promises'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  expect<span class="token punctuation">.</span><span class="token function">assertions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token function">expect</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'Mark'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Nous appelons <code>jest.mock('../requête')</code> pour dire à Jest d'utiliser notre fantaisie manuelle. Il s'attend à ce que la valeur de retour soit une Promesse qui va être résolue. Vous pouvez enchaîner autant de promesses que vous le souhaitez et appeler &quot;expect&quot; à tout moment, à condition de renvoyer une promesse à la fin.</p> <h2 id="resolves"><a href="#resolves" class="header-anchor">#</a> <code>.resolves</code></h2> <p>Il existe une manière moins verbeuse d'utiliser les <code>resolves</code> pour déballer la valeur d'une promesse tenue avec tout autre élément de correspondance. Si la promesse est rejetée, l'affirmation échouera.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'works with resolves'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  expect<span class="token punctuation">.</span><span class="token function">assertions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">expect</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>resolves<span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'Paul'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="async-await"><a href="#async-await" class="header-anchor">#</a> <code>async</code>/<code>await</code></h2> <p>Des tests d'écriture utilisant la syntaxe <code>async</code>/<code>await</code> sont également possibles. Voici comment vous pourriez écrire les mêmes exemples qu'auparavant :</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// async/await peut-être utilisé</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'works with async/await'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  expect<span class="token punctuation">.</span><span class="token function">assertions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'Mark'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// async/await peut-être aussi utilisé avec `.resolves`.</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'works with async/await and resolves'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  expect<span class="token punctuation">.</span><span class="token function">assertions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">expect</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>resolves<span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'Paul'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Pour activer async/await dans votre projet, installez <a href="https://babeljs.io/docs/en/babel-preset-env" target="_blank" rel="noopener noreferrer"><code>@babel/preset-env</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> et activez la fonction dans votre fichier <code>babel.config.js</code>.</p> <h2 id="traitement-des-erreurs"><a href="#traitement-des-erreurs" class="header-anchor">#</a> Traitement des erreurs</h2> <p>Les erreurs peuvent être traitées à l'aide de la méthode <code>catch</code>. Assurez-vous d'ajouter <code>expect.assertions</code> pour vérifier qu'un certain nombre d'assertions sont appelées. Sinon, une promesse remplie ne serait pas un échec :</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Test des erreurs d'asynchronisation à l'aide de Promise.catch.</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'tests error with promises'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  expect<span class="token punctuation">.</span><span class="token function">assertions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      error<span class="token operator">:</span> <span class="token string">'User with 2 not found.'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Ou utilisé async/await.</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'tests error with async/await'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  expect<span class="token punctuation">.</span><span class="token function">assertions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      error<span class="token operator">:</span> <span class="token string">'User with 1 not found.'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="rejects"><a href="#rejects" class="header-anchor">#</a> <code>.rejects</code></h2> <p>The<code>.rejects</code> helper works like the <code>.resolves</code> helper. If the promise is fulfilled, the test will automatically fail. <code>expect.assertions(number)</code> is not required but recommended to verify that a certain number of <a href="https://jestjs.io/docs/en/expect#expectassertionsnumber" target="_blank" rel="noopener noreferrer">assertions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> are called during a test. It is otherwise easy to forget to <code>return</code>/<code>await</code> the <code>.resolves</code> assertions.
L'aide <code>.rejects</code> fonctionne comme l'aide <code>.resolves</code>. Si la promesse est tenue, le test échouera automatiquement. L'aide <code>expect.assertions(number)</code> n'est pas obligatoire mais recommandée pour vérifier qu'un certain nombre d'<a href="https://jestjs.io/docs/en/expect#expectassertionsnumber" target="_blank" rel="noopener noreferrer">assertions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> sont appelées pendant un test. Sinon, il est facile d'oublier de <code>return</code>/<code>await</code> les assertions <code>.resolves</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Tester les erreurs d'asynchronisation à l'aide de `.rejects`.</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'tests error with rejects'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  expect<span class="token punctuation">.</span><span class="token function">assertions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">expect</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rejects<span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    error<span class="token operator">:</span> <span class="token string">'User with 3 not found.'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Ou en utilisant async/await avec `.rejects`.</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'tests error with async/await and rejects'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  expect<span class="token punctuation">.</span><span class="token function">assertions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">expect</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rejects<span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    error<span class="token operator">:</span> <span class="token string">'User with 3 not found.'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Le code de cet exemple est disponible sur <a href="https://github.com/facebook/jest/tree/master/examples/async" target="_blank" rel="noopener noreferrer">examples/async<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Si vous souhaitez tester des minuteries, comme <code>setTimeout</code>, consultez la documentation <a href="/jest/Guides/TimerMocks.html">Timer mocks</a>.</p> <h1 id="timer-fictifs"><a href="#timer-fictifs" class="header-anchor">#</a> Timer fictifs</h1> <p>Les fonctions de temporisation natives (c'est-à-dire <code>setTimeout</code>, <code>setInterval</code>, <code>clearTimeout</code>, <code>clearInterval</code>) sont loin d'être idéales pour un environnement de test puisqu'elles dépendent du temps réel pour s'écouler. Jest peut remplacer les temporisateurs par des fonctions qui vous permettent de contrôler le passage du temps. <a href="https://www.youtube.com/watch?v=QZoJ2Pt27BY" target="_blank" rel="noopener noreferrer">Great Scott !<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// timerGame.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">timerGame</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Ready....go!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Time's up -- stop!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> timerGame<span class="token punctuation">;</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// __tests__/timerGame-test.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

jest<span class="token punctuation">.</span><span class="token function">useFakeTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'waits 1 second before ending the game'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> timerGame <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../timerGame'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">timerGame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>setTimeout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>setTimeout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenLastCalledWith</span><span class="token punctuation">(</span>expect<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span>Function<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Ici, nous activons les faux chronomètres en appelant <code>jest.useFakeTimers();</code>. Cela permet de simuler setTimeout et d'autres fonctions de minuterie avec des fonctions fictives. Si vous exécutez plusieurs tests dans un fichier ou un bloc de description, <code>jest.useFakeTimers();</code> peut être appelé avant chaque test manuellement ou avec une fonction de configuration telle que <code>beforeEach</code>. Si vous ne le faites pas, le compteur d'utilisation interne ne sera pas remis à zéro.</p> <h2 id="run-all-timers"><a href="#run-all-timers" class="header-anchor">#</a> Run All Timers</h2> <p>Un autre test que nous pourrions vouloir écrire pour ce module est celui qui affirme que le rappel est appelé après 1 seconde. Pour ce faire, nous allons utiliser les API de contrôle de la minuterie de Jest pour avancer rapidement le temps en plein milieu du test :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'calls the callback after 1 second'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> timerGame <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../timerGame'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> callback <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">timerGame</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// A l'heure actuelle, le rappel n'aurait pas encore dû être effectuer</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Avance rapide jusqu'à ce que toutes les minuteries aient été exécutées</span>
  jest<span class="token punctuation">.</span><span class="token function">runAllTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Maintenant, notre rappel aurait dû être appelé !</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="minuteries-en-attente"><a href="#minuteries-en-attente" class="header-anchor">#</a> Minuteries en attente</h2> <p>Il existe aussi des scénarios où vous pourriez avoir un minuteur récursif, c'est-à-dire un minuteur qui fixe un nouveau minuteur dans son propre rappel. Pour ces cas, faire tourner tous les timers serait une boucle sans fin... donc quelque chose comme <code>jest.runAllTimers()</code> n'est pas souhaitable. Pour ces cas, vous pouvez utiliser <code>jest.runOnlyPendingTimers()</code> :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// infiniteTimerGame.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">infiniteTimerGame</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Ready....go!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Time's up! 10 seconds before the next game starts...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Programmer le prochain match dans 10 secondes</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">infiniteTimerGame</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> infiniteTimerGame<span class="token punctuation">;</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// __tests__/infiniteTimerGame-test.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

jest<span class="token punctuation">.</span><span class="token function">useFakeTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'infiniteTimerGame'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'schedules a 10-second timer after 1 second'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> infiniteTimerGame <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../infiniteTimerGame'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> callback <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">infiniteTimerGame</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// À ce stade, il aurait dû y avoir un seul appel à</span>
    <span class="token comment">// setTimeout pour programmer la fin du match en 1 seconde.</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>setTimeout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>setTimeout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenLastCalledWith</span><span class="token punctuation">(</span>expect<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span>Function<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Avance rapide et épuisement uniquement des chronomètres actuellement en cours</span>
    <span class="token comment">// (mais pas les nouveaux minuteurs qui sont créés au cours de ce processus)</span>
    jest<span class="token punctuation">.</span><span class="token function">runOnlyPendingTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// A ce stade, notre chronomètre de 1 seconde aurait dû déclencher son rappel</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Et il aurait dû créer un nouveau minuteur pour recommencer le jeu en</span>
    <span class="token comment">// 10 secondes</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>setTimeout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>setTimeout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenLastCalledWith</span><span class="token punctuation">(</span>expect<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span>Function<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="minuteurs-avances-par-temps"><a href="#minuteurs-avances-par-temps" class="header-anchor">#</a> Minuteurs avancés par temps</h2> <h5 id="renommer-de-runtimerstotime-a-advancetimersbytime-dans-jest-22-0-0"><a href="#renommer-de-runtimerstotime-a-advancetimersbytime-dans-jest-22-0-0" class="header-anchor">#</a> Renommer de <code>runTimersToTime</code> à <code>advanceTimersByTime</code> dans Jest <strong>22.0.0</strong></h5> <p>Une autre possibilité est d'utiliser <code>jest.advanceTimersByTime(msToRun)</code>. Lorsque cette API est appelée, tous les timers sont avancés de &quot;msToRun&quot; millisecondes. Toutes les &quot;macro-tâches&quot; en attente qui ont été mises en file d'attente via setTimeout() ou setInterval(), et qui seraient exécutées pendant ce laps de temps, seront exécutées. En outre, si ces macro-tâches prévoient de nouvelles macro-tâches qui seraient exécutées dans le même délai, celles-ci seront exécutées jusqu'à ce qu'il ne reste plus de macro-tâches dans la file d'attente qui devraient être exécutées dans les msToRun millisecondes.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// timerGame.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">timerGame</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Ready....go!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Time's up -- stop!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> timerGame<span class="token punctuation">;</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'calls the callback after 1 second via advanceTimersByTime'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> timerGame <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../timerGame'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> callback <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">timerGame</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// À ce stade, le rappel ne devrait pas encore avoir été appelé</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Avance rapide jusqu'à ce que toutes les minuteries aient été exécutées</span>
  jest<span class="token punctuation">.</span><span class="token function">advanceTimersByTime</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Maintenant, notre rappel aurait dû être appelé !</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Enfin, il peut parfois être utile, dans certains tests, de pouvoir effacer tous les chronomètres en attente. Pour cela, nous avons <code>jest.clearAllTimers()</code>.</p> <p>Le code de cet exemple est disponible à l'adresse [exemples/timer].(https://github.com/facebook/jest/tree/master/examples/timer).</p> <h1 id="simulation-manuelle"><a href="#simulation-manuelle" class="header-anchor">#</a> Simulation manuelle</h1> <p>Des simulations manuelles sont utilisées pour masquer les fonctionnalités à l'aide de données fictives. Par exemple, au lieu d'accéder à une ressource distante comme un site web ou une base de données, vous pouvez créer une simulation manuelle qui vous permet d'utiliser de fausses données. Cela garantit que vos tests seront rapides et ne seront pas faussés.</p> <h2 id="modules-utilisateurs-fictifs"><a href="#modules-utilisateurs-fictifs" class="header-anchor">#</a> Modules utilisateurs fictifs</h2> <p>Les simulations manuelles sont définies par l'écriture d'un module dans un sous-répertoire <code>__mocks__/</code> immédiatement adjacent au module. Par exemple, pour simuler un module appelé <code>user</code> dans le répertoire <code>models</code>, créez un fichier appelé <code>user.js</code> et placez-le dans le répertoire <code>models/__mocks</code>. Notez que le répertoire <code>__mocks__</code> est sensible à la casse, donc le fait de nommer le répertoire <code>__MOCKS__</code> va casser sur certains systèmes.</p> <blockquote><p>Lorsque nous avons besoin de ce module dans nos tests, il faut explicitement appeler <code>jest.mock('./moduleName')</code>.</p></blockquote> <h2 id="modules-de-nœuds-fictifs"><a href="#modules-de-nœuds-fictifs" class="header-anchor">#</a> Modules de nœuds fictifs</h2> <p>Si le module que vous simulez est un module Node (par exemple : <code>lodash</code>), le mock doit être placé dans le répertoire <code>__mocks__</code> adjacent à <code>node_modules</code> (sauf si vous avez configuré <a href="/jest/Guides/Configuration.html#roots-arraystring"><code>roots</code></a> pour pointer vers un dossier autre que la racine du projet) et sera <strong>automatiquement</strong> mocké. Il n'est pas nécessaire d'appeler explicitement <code>jest.mock('nom_du_module')</code>.</p> <p>Les modules scopés peuvent être simulés en créant un fichier dans une structure de répertoire qui correspond au nom du module simulé. Par exemple, pour simuler un module appelé <code>@scope/project-name</code>, créez un fichier à <code>__mocks__/@scope/project-name.js</code>, en créant le répertoire <code>@scope/</code> en conséquence.</p> <blockquote><p>Attention : Si nous voulons simuler les modules de base du Node (par exemple : <code>fs</code> ou <code>path</code>), alors l'appel explicite de <code>jest.mock('path')</code> est <strong>requis</strong>, parce que les modules de base du Node ne sont pas simulés par défaut.</p></blockquote> <h2 id="exemples"><a href="#exemples" class="header-anchor">#</a> Exemples</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">.</span>
├── config
├── __mocks__
│   └── fs.js
├── models
│   ├── __mocks__
│   │   └── user.js
│   └── user.js
├── node_modules
└── views
</code></pre></div><p>Lorsqu'une simulation manuelle existe pour un module donné, le système de modules de Jest utilisera ce module en appelant explicitement <code>jest.mock('moduleName')</code>. Cependant, lorsque <code>automock</code> est défini sur <code>true</code>, l'implémentation manuelle de la fantaisie sera utilisée au lieu de la fantaisie créée automatiquement, même si <code>jest.mock('nomdumodules')</code> n'est pas appelé. Pour éviter ce comportement, vous devrez appeler explicitement <code>jest.unmock('nomdumodèle')</code> dans les tests qui doivent utiliser l'implémentation réelle du module.</p> <blockquote><p>Note : Afin de se moquer correctement, Jest a besoin que <code>jest.mock('moduleName')</code> soit dans la même portée que l'instruction <code>require/import</code>.</p></blockquote> <p>Voici un exemple d'implémentation où nous avons un module qui fournit un résumé de tous les fichiers d'un répertoire donné. Dans ce cas, nous utilisons le module de base (intégré) <code>fs</code>.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// FileSummarizer.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">summarizeFilesInDirectorySync</span><span class="token punctuation">(</span><span class="token parameter">directory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>directory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">fileName</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    directory<span class="token punctuation">,</span>
    fileName<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

exports<span class="token punctuation">.</span>summarizeFilesInDirectorySync <span class="token operator">=</span> summarizeFilesInDirectorySync<span class="token punctuation">;</span>
</code></pre></div><p>Comme nous voulons que nos tests évitent de toucher le disques (qui est assez lent et fragile), nous créons une simulation manuelle pour le module <code>fs</code> en étendant une maquette automatique. Notre modèle manuel implémentera des versions personnalisées des API <code>fs</code> sur lesquelles nous pourrons nous appuyer pour nos tests :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// __mocks__/fs.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> fs <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">createMockFromModule</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Il s'agit d'une fonction personnalisée que nos tests peuvent utiliser lors de la configuration pour spécifier</span>
<span class="token comment">// à quoi doivent ressembler les fichiers du système de fichiers `mock` lorsque l'uns des API `fs` est utilisée.</span>
<span class="token comment">// `fs` APIs are used.</span>
<span class="token keyword">let</span> mockFiles <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">__setMockFiles</span><span class="token punctuation">(</span><span class="token parameter">newMockFiles</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  mockFiles <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> file <span class="token keyword">in</span> newMockFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mockFiles<span class="token punctuation">[</span>dir<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mockFiles<span class="token punctuation">[</span>dir<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mockFiles<span class="token punctuation">[</span>dir<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Une version personnalisée de `readdirSync` qui lit à partir de la simulation spéciale</span>
<span class="token comment">// liste de fichiers établie via __setMockFiles</span>
<span class="token keyword">function</span> <span class="token function">readdirSync</span><span class="token punctuation">(</span><span class="token parameter">directoryPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> mockFiles<span class="token punctuation">[</span>directoryPath<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

fs<span class="token punctuation">.</span>__setMockFiles <span class="token operator">=</span> __setMockFiles<span class="token punctuation">;</span>
fs<span class="token punctuation">.</span>readdirSync <span class="token operator">=</span> readdirSync<span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> fs<span class="token punctuation">;</span>
</code></pre></div><p>Maintenant, que nous écrivons notre test. Notez que nous devons dire explicitement que nous voulons simuler le module <code>fs</code> parce que c'est un module de base de Node :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// __tests__/FileSummarizer-test.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'listFilesInDirectorySync'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token constant">MOCK_FILE_INFO</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'/path/to/file1.js'</span><span class="token operator">:</span> <span class="token string">'console.log(&quot;file1 contents&quot;);'</span><span class="token punctuation">,</span>
    <span class="token string">'/path/to/file2.txt'</span><span class="token operator">:</span> <span class="token string">'file2 contents'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Mettre en place des informations fictives sur les fichiers avant chaque test</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">__setMockFiles</span><span class="token punctuation">(</span><span class="token constant">MOCK_FILE_INFO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'includes all files in the directory in the summary'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> FileSummarizer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../FileSummarizer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> fileSummary <span class="token operator">=</span> FileSummarizer<span class="token punctuation">.</span><span class="token function">summarizeFilesInDirectorySync</span><span class="token punctuation">(</span>
      <span class="token string">'/path/to'</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>fileSummary<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>L'exemple présenté ici utilise <a href="/jest/Guides/JestObjectAPI.html#jestcreatemockfrommodulemodulename"><code>jest.createMockFromModule</code></a> pour générer un modèle automatique, et remplace son comportement par défaut. C'est l'approche recommandée, mais elle est totalement optionnelle. Si vous ne souhaitez pas du tout utiliser la simulation automatique, vous pouvez exporter vos propres fonctions à partir du fichier de simulation. L'inconvénient des simulations entièrement manuelles est qu'elles sont manuelles, ce qui signifie que vous devez les mettre à jour manuellement chaque fois que le module dont elles sont issues change. C'est pourquoi il est préférable d'utiliser ou d'étendre la maquette automatique lorsqu'elle répond à vos besoins.</p> <p>Pour s'assurer qu'une simulation manuelle et son implémentation réelle restent synchronisées, il peut être utile d'exiger le module réel en utilisant <a href="/jest/Guides/JestObjectAPI.html#jestrequireactualmodulename"><code>jest.requireActual(moduleName)</code></a> dans votre simulation manuelle et de la modifier avec les fonctions de la simulation avant de l'exporter.</p> <p>Le code pour cet exemple est disponible sur le site <a href="https://github.com/facebook/jest/tree/master/examples/manual-mocks" target="_blank" rel="noopener noreferrer">examples/manual-mocks<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="utilisation-avec-les-importations-de-modules-es"><a href="#utilisation-avec-les-importations-de-modules-es" class="header-anchor">#</a> Utilisation avec les importations de modules ES</h2> <p>Si vous utilisez <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import" target="_blank" rel="noopener noreferrer">ES module imports<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, vous serez normalement enclin à placer vos déclarations d'importation en haut du fichier test. Mais souvent, vous devez demander à Jest d'utiliser une simulation avant que les modules ne l'utilisent. Pour cette raison, Jest hissera automatiquement les appels <code>jest.mock</code> en haut du module (avant toute importation). Pour en savoir plus sur ce système et le voir en action, consultez <a href="https://github.com/kentcdodds/how-jest-mocking-works" target="_blank" rel="noopener noreferrer">ce repo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="les-methodes-de-simulations-qui-ne-sont-pas-mises-en-œuvre-dans-jsdom"><a href="#les-methodes-de-simulations-qui-ne-sont-pas-mises-en-œuvre-dans-jsdom" class="header-anchor">#</a> Les méthodes de simulations qui ne sont pas mises en œuvre dans JSDOM</h2> <p>Si certains codes utilisent une méthode que le JSDOM (l'implémentation DOM utilisée par Jest) n'a pas encore mise en œuvre, il n'est pas facile de la tester. C'est par exemple le cas avec <code>window.matchMedia()</code>. Jest retourne <code>TypeError : window.matchMedia n'est pas une fonction</code> et n'exécute pas correctement le test.</p> <p>Dans ce cas, la simulation de <code>matchMedia</code> dans le fichier de test devrait résoudre le problème :</p> <div class="language-js extra-class"><pre class="language-js"><code>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token string">'matchMedia'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  value<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token parameter">query</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    matches<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    media<span class="token operator">:</span> query<span class="token punctuation">,</span>
    onchange<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    addListener<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// déprécié</span>
    removeListener<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// déprécié</span>
    addEventListener<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    removeEventListener<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    dispatchEvent<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Cela fonctionne si <code>window.matchMedia()</code> est utilisé dans une fonction (ou méthode) qui est invoquée dans le test. Si <code>window.matchMedia()</code> est exécuté directement dans le fichier testé, Jest signale la même erreur. Dans ce cas, la solution est de déplacer la simulation manuelle dans un fichier séparé et d'inclure celui-ci dans le test <strong>before</strong> le fichier testé :</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token string">'./matchMedia.mock'</span><span class="token punctuation">;</span> <span class="token comment">// Doit être importé avant le fichier testé</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>myMethod<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./file-to-test'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'myMethod()'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Testez la méthode ici...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="les-classes-es6-fictives"><a href="#les-classes-es6-fictives" class="header-anchor">#</a> Les classes ES6 fictives</h1> <p>Jest peut-être utilisé pour simuler les classes ES6 qui sont importées dans les fichiers que vous voulez tester.</p> <p>Les classes ES6 sont des fonctions de construction avec un peu de sucre syntaxique. Par conséquent, toute simulation d'une classe ES6 doit être une fonction d'une classe ES6 réelle (qui est, encore une fois, une autre fonction). Vous pouvez donc les simuler en utilisant des <a href="/jest/Guides/MockFunctions.html">fonctions simulées</a></p> <h2 id="un-exemple-de-classe-es6"><a href="#un-exemple-de-classe-es6" class="header-anchor">#</a> Un exemple de classe ES6</h2> <p>Nous utiliserons un exemple inventé d'une classe qui joue des fichiers sonores, <code>SoundPlayer</code>, et une classe de consommateurs qui utilise cette classe, <code>SoundPlayerConsumer</code>. Nous simulerons <code>SoundPlayer</code> dans nos tests pour <code>SoundPlayerConsumer</code>.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// sound-player.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">SoundPlayer</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token string">'bar'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">playSoundFile</span><span class="token punctuation">(</span><span class="token parameter">fileName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Playing sound file '</span> <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// sound-player-consumer.js</span>
<span class="token keyword">import</span> SoundPlayer <span class="token keyword">from</span> <span class="token string">'./sound-player'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">SoundPlayerConsumer</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>soundPlayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoundPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">playSomethingCool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> coolSoundFileName <span class="token operator">=</span> <span class="token string">'song.mp3'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>soundPlayer<span class="token punctuation">.</span><span class="token function">playSoundFile</span><span class="token punctuation">(</span>coolSoundFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="les-4-facons-de-creer-une-simulation-de-classe-es6"><a href="#les-4-facons-de-creer-une-simulation-de-classe-es6" class="header-anchor">#</a> Les 4 façons de créer une simulation de classe ES6</h2> <h3 id="simulation-automatique"><a href="#simulation-automatique" class="header-anchor">#</a> Simulation automatique</h3> <p>Appeler <code>jest.mock('./sound-player')</code> renvoie un &quot;mock automatique&quot; utile que vous pouvez utiliser pour espionner les appels au constructeur de la classe et toutes ses méthodes. Il remplace la classe ES6 par un constructeur fictif, et remplace toutes ses méthodes par des <a href="/jest/Guides/MockFunctions.html">fonctions fictives</a> qui retournent toujours <code>undefined</code>. Les appels de méthodes sont enregistrés dans <code>theAutomaticMock.mock.instances[index].methodName.mock.calls</code>.</p> <p>Veuillez noter que si vous utilisez des fonctions flèches dans vos classes, elles ne feront <em>pas</em> partie de la simulation. La raison en est que les fonctions flèches ne sont pas présentes sur le prototype e l'objet, il s'agit simplement de propriétés contenant une référence à une fonction.</p> <p>Si vous n'avez pas besoin de remplacer l'implémentation de la classe, c'est l'option la plus facile à mettre en place. Par exemple :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> SoundPlayer <span class="token keyword">from</span> <span class="token string">'./sound-player'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> SoundPlayerConsumer <span class="token keyword">from</span> <span class="token string">'./sound-player-consumer'</span><span class="token punctuation">;</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'./sound-player'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// SoundPlayer est désormais un constructeur fictif</span>

<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token comment">// Effacer toutes les instances et appels au constructeur et toutes les méthodes :</span>
  SoundPlayer<span class="token punctuation">.</span><span class="token function">mockClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'We can check if the consumer called the class constructor'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> soundPlayerConsumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoundPlayerConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>SoundPlayer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'We can check if the consumer called a method on the class instance'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Montrer que mockClear() fonctionne :</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>SoundPlayer<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> soundPlayerConsumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoundPlayerConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Le constructeur aurait dû être rappelé :</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>SoundPlayer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> coolSoundFileName <span class="token operator">=</span> <span class="token string">'song.mp3'</span><span class="token punctuation">;</span>
  soundPlayerConsumer<span class="token punctuation">.</span><span class="token function">playSomethingCool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// mock.instances est disponible avec des maquettes automatiques :</span>
  <span class="token keyword">const</span> mockSoundPlayerInstance <span class="token operator">=</span> SoundPlayer<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>instances<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mockPlaySoundFile <span class="token operator">=</span> mockSoundPlayerInstance<span class="token punctuation">.</span>playSoundFile<span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>mockPlaySoundFile<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>calls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span>coolSoundFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Equivalent à la vérification ci-dessus :</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>mockPlaySoundFile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span>coolSoundFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>mockPlaySoundFile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="simulation-manuelle-2"><a href="#simulation-manuelle-2" class="header-anchor">#</a> Simulation manuelle</h3> <p>Créez une [maquette manuelle] (ManualMocks.md) en enregistrant une implémentation de la simulation dans le dossier <code>__mocks__</code>. Cela vous permet de spécifier l'implémentation, et elle peut être utilisée dans tous les fichiers de test.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// __mocks__/sound-player.js</span>

<span class="token comment">// Importez cette exportation nommée dans votre fichier test :</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> mockPlaySoundFile <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mock <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>playSoundFile<span class="token operator">:</span> mockPlaySoundFile<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> mock<span class="token punctuation">;</span>
</code></pre></div><p>Importez la simulation et la méthode de la simulation partagés par toutes les instances :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// sound-player-consumer.test.js</span>
<span class="token keyword">import</span> SoundPlayer<span class="token punctuation">,</span> <span class="token punctuation">{</span>mockPlaySoundFile<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./sound-player'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> SoundPlayerConsumer <span class="token keyword">from</span> <span class="token string">'./sound-player-consumer'</span><span class="token punctuation">;</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'./sound-player'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// SoundPlayer est désormais un constructeur fictif</span>

<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Effacer toutes les instances et appels au constructeur et toutes les méthodes :</span>
  SoundPlayer<span class="token punctuation">.</span><span class="token function">mockClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mockPlaySoundFile<span class="token punctuation">.</span><span class="token function">mockClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'We can check if the consumer called the class constructor'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> soundPlayerConsumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoundPlayerConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>SoundPlayer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'We can check if the consumer called a method on the class instance'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> soundPlayerConsumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoundPlayerConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> coolSoundFileName <span class="token operator">=</span> <span class="token string">'song.mp3'</span><span class="token punctuation">;</span>
  soundPlayerConsumer<span class="token punctuation">.</span><span class="token function">playSomethingCool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>mockPlaySoundFile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span>coolSoundFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="appeler-jest-mock-avec-le-parametre-d-usine-du-module"><a href="#appeler-jest-mock-avec-le-parametre-d-usine-du-module" class="header-anchor">#</a> Appeler <a href="/jest/Guides/JestObjectAPI.html#jestmockmodulename-factory-options"><code>jest.mock()</code></a> avec le paramètre d'usine du module</h3> <p><code>jest.mock(path, moduleFactory)</code> prend un argument de <strong>module factory</strong>. Une usine de modules est une fonction qui renvoie la simulation.</p> <p>Afin de simuler une fonction de constructeur, la fabrique de modules doit retourner une fonction de constructeur. En d'autres termes, la fabrique de modules doit être une fonction qui renvoie une fonction - une fonction d'ordre supérieur (HOF).</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> SoundPlayer <span class="token keyword">from</span> <span class="token string">'./sound-player'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mockPlaySoundFile <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'./sound-player'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>playSoundFile<span class="token operator">:</span> mockPlaySoundFile<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Une limitation avec le paramètre d'usine est que, puisque les appels à <code>jest.mock()</code> sont hissés au sommet du fichier, il n'est pas possible de définir d'abord une variable et de l'utiliser ensuite dans l'usine. Une exception est faite pour les variables qui commencent par le mot &quot;mock&quot;. C'est à vous de garantir qu'elles seront initialisées à temps ! Par exemple, voici un exemple d'erreur hors champ due à l'utilisation de &quot;fake&quot; au lieu de &quot;mock&quot; dans la déclaration de la variable :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Note: ce sera un échec</span>
<span class="token keyword">import</span> SoundPlayer <span class="token keyword">from</span> <span class="token string">'./sound-player'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fakePlaySoundFile <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'./sound-player'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>playSoundFile<span class="token operator">:</span> fakePlaySoundFile<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="remplacement-de-la-simulation-en-utilisant-mockimplementation-ou-mockimplementationonce"><a href="#remplacement-de-la-simulation-en-utilisant-mockimplementation-ou-mockimplementationonce" class="header-anchor">#</a> Remplacement de la simulation en utilisant <a href="/jest/Guides/MockFunctionAPI.html#mockfnmockimplementationfn"><code>mockImplementation()</code></a> ou <a href="/jest/Guides/MockFunctionAPI.html#mockfnmockimplementationoncefn"><code>mockImplementationOnce()</code></a></h3> <p>Vous pouvez remplacer toutes les simulations ci-dessus afin de modifier l'implémentation, pour un seul test ou pour tous les tests, en appelant <code>mockImplementation()</code> sur la simulation existante.</p> <p>Les appels à jest.mock sont placés en haut du code. Vous pouvez spécifier un objet fictif plus tard, par exemple dans <code>beforeAll()</code>, en appelant <code>mockImplementation()</code> (ou <code>mockImplementationOnce()</code>) sur l'objet fictif existant au lieu d'utiliser le paramètre d'usine. Cela vous permet également de changer la simulation entre les tests, si nécessaire :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> SoundPlayer <span class="token keyword">from</span> <span class="token string">'./sound-player'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> SoundPlayerConsumer <span class="token keyword">from</span> <span class="token string">'./sound-player-consumer'</span><span class="token punctuation">;</span>

jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'./sound-player'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'When SoundPlayer throws an error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    SoundPlayer<span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">playSoundFile</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Test error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'Should throw an error when calling playSomethingCool'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> soundPlayerConsumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoundPlayerConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> soundPlayerConsumer<span class="token punctuation">.</span><span class="token function">playSomethingCool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toThrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="en-profondeur-comprendre-les-fonctions-du-constructeur-fictif"><a href="#en-profondeur-comprendre-les-fonctions-du-constructeur-fictif" class="header-anchor">#</a> En profondeur : Comprendre les fonctions du constructeur fictif</h2> <p>La construction de votre fonction de construction fictive en utilisant <code>jest.fn().mockImplementation()</code> fait paraître les ficelles plus compliquées qu'elles ne le sont en réalité. Cette section montre comment vous pouvez créer vos propres simulations pour illustrer le fonctionnement de la simulation.</p> <h3 id="simulation-manuelle-qui-est-une-autre-classe-es6"><a href="#simulation-manuelle-qui-est-une-autre-classe-es6" class="header-anchor">#</a> Simulation manuelle qui est une autre classe ES6</h3> <p>Si vous définissez une classe ES6 en utilisant le même nom de fichier que la classe fantaisie dans le dossier <code>__mocks__</code>, elle servira de fantaisie. Cette classe sera utilisée à la place de la classe réelle. Cela vous permet d'injecter une implémentation de test pour la classe, mais ne fournit pas de moyen d'espionner les appels.</p> <p>Pour l'exemple inventé, le mock pourrait ressembler à ceci :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// __mocks__/sound-player.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">SoundPlayer</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Mock SoundPlayer: constructor was called'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">playSoundFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Mock SoundPlayer: playSoundFile was called'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="maquette-utilisant-le-parametre-d-usine-du-module"><a href="#maquette-utilisant-le-parametre-d-usine-du-module" class="header-anchor">#</a> Maquette utilisant le paramètre d'usine du module</h3> <p>La fonction module factory passée à <code>jest.mock(path, moduleFactory)</code> peut être un HOF qui renvoie une fonction*. Cela permettra d'appeler <code>new</code> sur le mock. Encore une fois, cela permet d'injecter un comportement différent pour les tests, mais ne permet pas d'espionner les appels.</p> <h4 id="la-fonction-d-usine-du-module-doit-renvoyer-une-fonction"><a href="#la-fonction-d-usine-du-module-doit-renvoyer-une-fonction" class="header-anchor">#</a> * La fonction d'usine du module doit renvoyer une fonction</h4> <p>Afin de simuler une fonction de constructeur, l'usine de modules doit renvoyer une fonction de constructeur. En d'autres termes, la fabrique de modules doit être une fonction qui renvoie une fonction - une fonction d'ordre supérieur (HOF).</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'./sound-player'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token function-variable function">playSoundFile</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong><em>Note: Les fonctions fléchées  ne fonctionnent pas</em></strong></p> <p>Notez que la simulation ne peut pas être une fonction fléchée car l'appel de &quot;nouveau&quot; sur une fonction flèchée n'est pas autorisé en JavaScript. Cela ne fonctionnera donc pas :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'./sound-player'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Ne fonctionne pas ; les fonctions fléchées ne peuvent pas être appelées avec de nouvelles</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token function-variable function">playSoundFile</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Cela entraînera une erreur de type <strong><em>TypeError : _soundPlayer2.default n'est pas un constructor</em></strong>, sauf si le code est transposé à ES5, par exemple par <code>@babel/preset-env</code>. (ES5 n'a pas de fonctions de flèches ni de classes, donc les deux seront transposées en fonctions simples).</p> <h2 id="garder-une-trace-de-l-utilisation-espionnage-du-simulacre"><a href="#garder-une-trace-de-l-utilisation-espionnage-du-simulacre" class="header-anchor">#</a> Garder une trace de l'utilisation (espionnage du simulacre)</h2> <p>L'injection d'une implémentation de test est utile, mais vous voudrez probablement aussi tester si le constructeur de classe et les méthodes sont appelés avec les bons paramètres.</p> <h3 id="espionner-le-constructeur"><a href="#espionner-le-constructeur" class="header-anchor">#</a> Espionner le constructeur</h3> <p>Afin de suivre les appels au constructeur, remplacez la fonction renvoyée par le HOF par une fonction fictive Jest. Créez-la avec <a href="/jest/Guides/JestObjectAPI.html#jestfnimplementation"><code>jest.fn()</code></a>, puis spécifiez son implémentation avec <code>mockImplementation()</code>.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> SoundPlayer <span class="token keyword">from</span> <span class="token string">'./sound-player'</span><span class="token punctuation">;</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'./sound-player'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Fonctionne et vous permet de vérifier les appels des constructeurs :</span>
  <span class="token keyword">return</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token function-variable function">playSoundFile</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Cela nous permettra d'inspecter l'utilisation de notre classe fictive, en utilisant <code>SoundPlayer.mock.calls</code> : <code>expect(SoundPlayer).toHaveBeenCalled();</code> ou quasi-équivalent : <code>expect(SoundPlayer.mock.calls.length).toEqual(1);</code>.</p> <h3 id="se-moquer-des-exportations-hors-classe-de-defaut"><a href="#se-moquer-des-exportations-hors-classe-de-defaut" class="header-anchor">#</a> Se moquer des exportations hors classe de défaut</h3> <p>Si la classe est <strong>not</strong> l'exportation par défaut du module, vous devez renvoyer un objet avec la clé qui est la même que le nom de l'exportation de la classe.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>SoundPlayer<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./sound-player'</span><span class="token punctuation">;</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'./sound-player'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Fonctionne et vous permet de vérifier les appels des constructeurs :</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    SoundPlayer<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token function-variable function">playSoundFile</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="espionner-les-methodes-de-notre-classe"><a href="#espionner-les-methodes-de-notre-classe" class="header-anchor">#</a> Espionner les méthodes de notre classe</h3> <p>Notre classe simulée devra fournir toutes les fonctions membres (<code>playSoundFile</code> dans l'exemple) qui seront appelées pendant nos tests, sinon nous obtiendrons une erreur pour avoir appelé une fonction qui n'existe pas. Mais nous voudrons probablement aussi espionner les appels à ces méthodes, pour nous assurer qu'elles ont été appelées avec les paramètres attendus.</p> <p>Un nouvel objet sera créé à chaque fois que la fonction de constructeur fictif sera appelée pendant les tests. Pour espionner les appels de méthode dans tous ces objets, nous remplissons <code>playSoundFile</code> avec une autre fonction fantaisie, et nous stockons une référence à cette même fonction fantaisie dans notre fichier de test, afin qu'elle soit disponible pendant les tests.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> SoundPlayer <span class="token keyword">from</span> <span class="token string">'./sound-player'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mockPlaySoundFile <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'./sound-player'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>playSoundFile<span class="token operator">:</span> mockPlaySoundFile<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// Nous pouvons maintenant suivre les appels à playSoundFile</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>L'équivalent manuel simulé serait :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// __mocks__/sound-player.js</span>

<span class="token comment">// Importez cette exportation nommée dans votre fichier test</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> mockPlaySoundFile <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mock <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>playSoundFile<span class="token operator">:</span> mockPlaySoundFile<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> mock<span class="token punctuation">;</span>
</code></pre></div><p>L'utilisation est similaire à la fonction d'usine du module, sauf que vous pouvez omettre le second argument de <code>jest.mock()</code>, et vous devez importer la méthode fantaisie dans votre fichier de test, puisqu'elle n'y est plus définie. Utilisez pour cela le chemin d'accès original du module ; n'incluez pas <code>__mocks__</code>.</p> <h3 id="nettoyage-entre-les-tests"><a href="#nettoyage-entre-les-tests" class="header-anchor">#</a> Nettoyage entre les tests</h3> <p>Pour nettoyer l'enregistrement des appels à la fonction du constructeur fictif et à ses méthodes, nous appelons <a href="/jest/Guides/MockFunctionAPI.html#mockfnmockclear"><code>mockClear()</code></a> dans la fonction <code>beforeEach()</code> :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  SoundPlayer<span class="token punctuation">.</span><span class="token function">mockClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mockPlaySoundFile<span class="token punctuation">.</span><span class="token function">mockClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="exemple-complet"><a href="#exemple-complet" class="header-anchor">#</a> Exemple complet</h2> <p>Voici un fichier de test complet qui utilise le paramètre d'usine du module pour <code>jest.mock</code> :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// sound-player-consumer.test.js</span>
<span class="token keyword">import</span> SoundPlayerConsumer <span class="token keyword">from</span> <span class="token string">'./sound-player-consumer'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> SoundPlayer <span class="token keyword">from</span> <span class="token string">'./sound-player'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> mockPlaySoundFile <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'./sound-player'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>playSoundFile<span class="token operator">:</span> mockPlaySoundFile<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  SoundPlayer<span class="token punctuation">.</span><span class="token function">mockClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mockPlaySoundFile<span class="token punctuation">.</span><span class="token function">mockClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'The consumer should be able to call new() on SoundPlayer'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> soundPlayerConsumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoundPlayerConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// S'assurer que le constructeur a créé l'objet :</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>soundPlayerConsumer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'We can check if the consumer called the class constructor'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> soundPlayerConsumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoundPlayerConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>SoundPlayer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'We can check if the consumer called a method on the class instance'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> soundPlayerConsumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoundPlayerConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> coolSoundFileName <span class="token operator">=</span> <span class="token string">'song.mp3'</span><span class="token punctuation">;</span>
  soundPlayerConsumer<span class="token punctuation">.</span><span class="token function">playSomethingCool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>mockPlaySoundFile<span class="token punctuation">.</span>mock<span class="token punctuation">.</span>calls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span>coolSoundFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="contourner-la-simulation-des-modules"><a href="#contourner-la-simulation-des-modules" class="header-anchor">#</a> Contourner la simulation des modules</h1> <p>Jest vous permet de simuler es modules entiers dans vos tests, ce qui peut être utile pour vérifier si votre code appelle correctement les fonctions de ce module. Cependant, il peut arriver que vous souhaitiez utiliser des parties d'un module simulé dans votre fichier <em>test</em>, auquel cas vous souhaitez accéder à l'implémentation originale, plutôt qu'à une version simulée.</p> <p>Envisagez  d'écrire un scénario de test pour cette fonction <code>createUser</code> :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// createUser.js</span>
<span class="token keyword">import</span> fetch <span class="token keyword">from</span> <span class="token string">'node-fetch'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createUser</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://website.com/users'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> userId <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> userId<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Votre test devra faire la simulation de la fonction <code>fetch</code> afin que nous puissions être sûrs qu'elle soit appelée sans faire la demande aux réseaux. Cependant, vous devrez également simuler la valeur de retour de <code>fetch</code> avec <code>Response</code> (enveloppée dans une <code>promesse</code>), car notre fonction l'utilise pour saisir l'Id de l'utilisateur  créé. Vous pouvez donc essayer d'écrire un test comme celui-ci:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> fetch<span class="token punctuation">,</span> <span class="token punctuation">{</span>Response<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'node-fetch'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>createUser<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./createUser'</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'createUser calls fetch with the right args and returns the user id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  fetch<span class="token punctuation">.</span><span class="token function">mockReturnValue</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> userId <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>fetch<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>fetch<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token string">'http://website.com/users'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Cependant, si vous exécutez ce test, vous constaterez que la fonction <code>createUser</code> échouera, ce qui entraînera l'erreur suivante : <code>TypeError: response.text is not a function</code>. Ceci est dû au fait que la classe <code>Response</code> que vous avez importée de <code>node-fetch</code> a été simulée (à cause de l'appel <code>jest.mock</code> en haut du fichier de test) et qu'elle ne se comporte plus comme elle le devrait.</p> <p>Pour contourner ce genre de problème, Jest fournit l'aide <code>jest.requireActual</code>. Pour que le test ci-dessus fonctionne, apportez la modification suivante aux importations dans le fichier de test :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// AVANT</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> fetch<span class="token punctuation">,</span> <span class="token punctuation">{</span>Response<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'node-fetch'</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// APRES</span>
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> fetch <span class="token keyword">from</span> <span class="token string">'node-fetch'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>Response<span class="token punctuation">}</span> <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">requireActual</span><span class="token punctuation">(</span><span class="token string">'node-fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Cela permet à votre fichier de test d'importer l'objet <code>Response</code> réel de <code>node-fetch</code>, plutôt qu'une version fictive. Cela signifie que le test passera maintenant correctement.</p> <p>Jest peut être utilisé dans des projets qui utilisent <a href="https://webpack.js.org/" target="_blank" rel="noopener noreferrer">webpack<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> pour gérer les actifs, les styles et la compilation. webpack <em>does</em> offre des défis uniques par rapport aux autres outils car il s'intègre directement à votre application pour permettre la gestion des feuilles de style, des actifs comme les images et les polices, ainsi que le vaste écosystème de langages et d'outils de compilation vers JavaScript.</p> <h2 id="un-exemple-de-webpack"><a href="#un-exemple-de-webpack" class="header-anchor">#</a> Un exemple de webpack</h2> <p>Commençons par une sorte de fichier de configuration webpack commun et traduisons le en une configuration Jest.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    loaders<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>exclude<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> loader<span class="token operator">:</span> <span class="token string">'babel'</span><span class="token punctuation">,</span> test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.jsx?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>loader<span class="token operator">:</span> <span class="token string">'style-loader!css-loader'</span><span class="token punctuation">,</span> test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>loader<span class="token operator">:</span> <span class="token string">'url-loader'</span><span class="token punctuation">,</span> test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.gif$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>loader<span class="token operator">:</span> <span class="token string">'file-loader'</span><span class="token punctuation">,</span> test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(ttf|eot|svg)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  resolve<span class="token operator">:</span> <span class="token punctuation">{</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span>
      config$<span class="token operator">:</span> <span class="token string">'./configs/app-config.js'</span><span class="token punctuation">,</span>
      react<span class="token operator">:</span> <span class="token string">'./vendor/react-master'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'js'</span><span class="token punctuation">,</span> <span class="token string">'jsx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    modules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">'node_modules'</span><span class="token punctuation">,</span>
      <span class="token string">'bower_components'</span><span class="token punctuation">,</span>
      <span class="token string">'shared'</span><span class="token punctuation">,</span>
      <span class="token string">'/shared/vendor/modules'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Si vous avez des fichiers JavaScript qui sont transformés par Babel, vous pouvez [activer le support pour Babel] (GettingStarted.md#using-babel) en installant le plugin <code>babel-jest</code>. Les transformations JavaScript non-Babel peuvent être traitées avec l'option de configuration de Jest <a href="/jest/Guides/Configuration.html#transform-objectstring-pathtotransformer--pathtotransformer-object"><code>transform</code></a>.</p> <h3 id="gestion-des-actifs-statiques"><a href="#gestion-des-actifs-statiques" class="header-anchor">#</a> Gestion des actifs statiques</h3> <p>Ensuite, configurons Jest pour qu'il gère avec élégance les fichiers d'actifs tels que les feuilles de style et les images. Habituellement, ces fichiers ne sont pas particulièrement utiles dans les tests, donc nous pouvons les simuler en toute sécurité. Cependant, si vous utilisez des modules CSS, il est préférable de simuler un proxy pour vos recherches de noms de classe.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;moduleNameMapper&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;\\.(jpg|jpeg|png|gif|eot|otf|webp|svg|ttf|woff|woff2|mp4|webm|wav|mp3|m4a|aac|oga)$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;rootDir&gt;/__mocks__/fileMock.js&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;\\.(css|less)$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;rootDir&gt;/__mocks__/styleMock.js&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Et les fichiers fictifs eux-mêmes :</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// __mocks__/styleMock.js</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// __mocks__/fileMock.js</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">'test-file-stub'</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="modules-css-fictifs"><a href="#modules-css-fictifs" class="header-anchor">#</a> Modules CSS fictifs</h3> <p>Vous pouvez utiliser un <a href="https://github.com/keyanzhang/identity-obj-proxy" target="_blank" rel="noopener noreferrer">ES6 Proxy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> pour simuler les <a href="https://github.com/css-modules/css-modules" target="_blank" rel="noopener noreferrer">modules CSS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> :</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">yarn</span> <span class="token function">add</span> --dev identity-obj-proxy
</code></pre></div><p>Ensuite, toutes vos recherches className sur l'objet styles seront renvoyées telles quelles (par exemple, `styles.foobar === 'foobar'). C'est très pratique pour le test &quot;React [Snapshot Testing]&quot; (SnapshotTesting.md).</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json (for CSS Modules)</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;moduleNameMapper&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;\\.(jpg|jpeg|png|gif|eot|otf|webp|svg|ttf|woff|woff2|mp4|webm|wav|mp3|m4a|aac|oga)$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;rootDir&gt;/__mocks__/fileMock.js&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;\\.(css|less)$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;identity-obj-proxy&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>Remarquez que le proxy est activé par défaut dans le nœud 6. Si vous n'êtes pas encore sur le Node 6, assurez-vous que vous invoquez Jest en utilisant <code>node --harmony_proxies node_modules/.bin/jest</code>.</p></blockquote> <p>Si <code>moduleNameMapper</code> ne peut pas répondre à vos besoins, vous pouvez utiliser l'option de configuration de Jest <a href="/jest/Guides/Configuration.html#transform-objectstring-pathtotransformer--pathtotransformer-object"><code>transform</code></a> pour spécifier comment les actifs sont transformés. Par exemple, un transformateur qui renvoie le nom de base d'un fichier (tel que <code>require('logo.jpg');</code> renvoie <code>'logo'</code>) peut être écrit comme :</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// fileTransformer.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">process</span><span class="token punctuation">(</span><span class="token parameter">src<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> config<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'module.exports = '</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">';'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json (for custom transformers and CSS Modules)</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;moduleNameMapper&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;\\.(css|less)$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;identity-obj-proxy&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;transform&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;\\.(jpg|jpeg|png|gif|eot|otf|webp|svg|ttf|woff|woff2|mp4|webm|wav|mp3|m4a|aac|oga)$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;rootDir&gt;/fileTransformer.js&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Nous avons dit à Jest d'ignorer les fichiers correspondant à une feuille de style ou à une extension d'image, et d'exiger à la place nos fichiers fantaisie. Vous pouvez ajuster l'expression régulière pour qu'elle corresponde aux types de fichiers gérés par la configuration de votre webpack.</p> <p>Note : si vous utilisez babel-jest avec des préprocesseurs de code supplémentaires, vous devez définir explicitement babel-jest comme un transformateur pour votre code JavaScript afin de faire correspondre les fichiers <code>.js</code> au module babel-jest._</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;transform&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;^.+\\.js$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;babel-jest&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;^.+\\.css$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;custom-transformer&quot;</span><span class="token punctuation">,</span>
  ...
<span class="token punctuation">}</span>
</code></pre></div><h3 id="configurer-jest-pour-trouver-nos-fichiers"><a href="#configurer-jest-pour-trouver-nos-fichiers" class="header-anchor">#</a> Configurer Jest pour trouver nos fichiers</h3> <p>Maintenant que Jest sait comment traiter nos dossiers, nous devons lui dire comment les <em>trouver</em>. Pour les options <code>modulesDirectories</code> et <code>extensions</code> de webpack, il existe des analogues directs dans les options <code>moduleDirectories</code> et <code>moduleFileExtensions</code> de Jest.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;moduleFileExtensions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jsx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;moduleDirectories&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;node_modules&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bower_components&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;shared&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token property">&quot;moduleNameMapper&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;\\.(css|less)$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;rootDir&gt;/__mocks__/styleMock.js&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;\\.(gif|ttf|eot|svg)$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;rootDir&gt;/__mocks__/fileMock.js&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>Note : <code>&lt;rootDir&gt;</code> est un token spécial qui est remplacé par Jest avec la racine de votre projet. La plupart du temps, ce sera le dossier où se trouve votre <code>package.json</code> à moins que vous ne spécifiiez une option <code>rootDir</code> personnalisée dans votre configuration.</p></blockquote> <p>De même, l'option <code>resolve.root</code> de webpack fonctionne comme la variable <code>NODE_PATH</code> env, que vous pouvez définir, ou utiliser l'option <code>modulePaths</code>.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;modulePaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/shared/vendor/modules&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;moduleFileExtensions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jsx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;moduleDirectories&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;node_modules&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bower_components&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;shared&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;moduleNameMapper&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;\\.(css|less)$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;rootDir&gt;/__mocks__/styleMock.js&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;\\.(gif|ttf|eot|svg)$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;rootDir&gt;/__mocks__/fileMock.js&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Et enfin, nous devons gérer le webpack &quot;alias&quot;. Pour cela, nous pouvons à nouveau utiliser l'option &quot;moduleNameMapper&quot;.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;modulePaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/shared/vendor/modules&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;moduleFileExtensions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jsx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;moduleDirectories&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;node_modules&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bower_components&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;shared&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token property">&quot;moduleNameMapper&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;\\.(css|less)$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;rootDir&gt;/__mocks__/styleMock.js&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;\\.(gif|ttf|eot|svg)$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;rootDir&gt;/__mocks__/fileMock.js&quot;</span><span class="token punctuation">,</span>

      <span class="token property">&quot;^react(.*)$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;rootDir&gt;/vendor/react-master$1&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;^config$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;rootDir&gt;/configs/app-config.js&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>C'est tout ! Le webpack est un outil complexe et flexible, vous devrez donc peut-être procéder à quelques ajustements pour répondre aux besoins spécifiques de votre demande. Heureusement, pour la plupart des projets, Jest devrait être plus que suffisamment flexible pour gérer la configuration de votre webpack.</p> <blockquote><p>Note : Pour des configurations de webpack plus complexes, vous pouvez également envisager des projets tels que <a href="https://github.com/istarkov/babel-plugin-webpack-loaders" target="_blank" rel="noopener noreferrer">babel-plugin-webpack-loaders<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></blockquote> <h2 id="utilisation-avec-le-webpack-2"><a href="#utilisation-avec-le-webpack-2" class="header-anchor">#</a> Utilisation avec le webpack 2</h2> <p>webpack 2 offre un support natif pour les modules ES. Cependant, Jest fonctionne en Node, et nécessite donc la transposition des modules ES vers les modules CommonJS. Par conséquent, si vous utilisez le webpack 2, vous voudrez probablement configurer Babel pour transposer les modules ES en modules CommonJS uniquement dans l'environnement &quot;test&quot;.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// .babelrc</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token property">&quot;modules&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

  <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;transform-es2015-modules-commonjs&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>Note : Jest met en cache des fichiers pour accélérer l'exécution des tests. Si vous avez mis à jour le fichier .babelrc et que Jest ne fonctionne toujours pas, essayez d'exécuter Jest avec <code>--no-cache</code>.</p></blockquote> <p>Si vous utilisez les importations dynamiques (<code>import('some-file.js').then(module =&gt; ...)</code>), vous devez activer le plugin <code>dynamic-import-node</code>.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// .babelrc</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token property">&quot;modules&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

  <span class="token property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;syntax-dynamic-import&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

  <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;dynamic-import-node&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Pour un exemple d'utilisation de Jest avec Webpack avec React, Redux, et Node, vous pouvez en voir un <a href="https://github.com/jenniferabowd/jest_react_redux_node_webpack_complex_example" target="_blank" rel="noopener noreferrer">ici<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h1 id="l-utilisation-de-pupeteer"><a href="#l-utilisation-de-pupeteer" class="header-anchor">#</a> L'utilisation de Pupeteer</h1> <p>Avec les API <a href="/jest/Guides/Configuration.html#globalsetup-string">Global Setup/Teardown</a> et <a href="/jest/Guides/Configuration.html#testenvironment-string">Async Test Environment</a>, Jest peut fonctionner sans problème avec <a href="https://www.mongodb.com/" target="_blank" rel="noopener noreferrer">MongoDB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <blockquote><p>La génération de la couverture de code pour les fichiers de test utilisant Puppeteer n'est actuellement pas possible si votre test utilise <code>page.$eval</code>, <code>page.$$eval</code> ou <code>page.evaluate</code> car la fonction passée est exécutée en dehors du champ d'application de Jest. Consultez le <a href="https://github.com/facebook/jest/issues/7962#issuecomment-495272339" target="_blank" rel="noopener noreferrer">numéro 7962<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> sur GitHub pour une solution de contournement.</p></blockquote> <h2 id="utiliser-le-prereglage-de-jest-puppeteer"><a href="#utiliser-le-prereglage-de-jest-puppeteer" class="header-anchor">#</a> utiliser le préréglage de jest-puppeteer</h2> <p><a href="https://github.com/smooth-code/jest-puppeteer" target="_blank" rel="noopener noreferrer">Jest Puppeteer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> fournit toute la configuration requise pour effectuer vos tests en utilisant Puppeteer.</p> <ol><li>Tout d'abord, installer <code>jest-puppeteer</code></li></ol> <div class="language- extra-class"><pre class="language-text"><code>yarn add --dev jest-puppeteer
</code></pre></div><ol start="2"><li>Précisez le préréglage dans votre configuration Jest :</li></ol> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;preset&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jest-puppeteer&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>Ecrire le test</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Google'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">'https://google.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should be titled &quot;Google&quot;'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">expect</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">title</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>resolves<span class="token punctuation">.</span><span class="token function">toMatch</span><span class="token punctuation">(</span><span class="token string">'Google'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Il n'est pas nécessaire de charger des dépendances. Les classes &quot;page&quot; et &quot;navigateur&quot; de Puppeteer seront automatiquement exposées</p> <p>Voir la <a href="https://github.com/smooth-code/jest-puppeteer" target="_blank" rel="noopener noreferrer">documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="exemple-personnalise-sans-prereglage-de-jest-puppeteer"><a href="#exemple-personnalise-sans-prereglage-de-jest-puppeteer" class="header-anchor">#</a> Exemple personnalisé sans préréglage de jest-puppeteer</h2> <p>You can also hook up puppeteer from scratch. The basic idea is to:</p> <ol><li>launch &amp; file the websocket endpoint of puppeteer with Global Setup</li> <li>connect to puppeteer from each Test Environment</li> <li>close puppeteer with Global Teardown</li></ol> <p>Here's an example of the GlobalSetup script</p> <p>Vous pouvez également vous procurer un puppeteer en partant de zéro. L'idée de base est de :</p> <ol><li>lancer et classer l'extrémité du websocket de puppeteer avec Global Setup</li> <li>se connecter à puppeteer de chaque environnement de test</li> <li>Le puppeteer de proximité avec Global Teardown</li></ol> <p>Voici un exemple de script de GlobalSetup</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// setup.js</span>
<span class="token keyword">const</span> puppeteer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'puppeteer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mkdirp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mkdirp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">DIR</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">tmpdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'jest_puppeteer_global_setup'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// stocker l'instance du navigateur pour pouvoir la démonter plus tard</span>
  <span class="token comment">// ce global n'est disponible que dans le démontage mais pas dans TestEnvironments</span>
  global<span class="token punctuation">.</span>__BROWSER_GLOBAL__ <span class="token operator">=</span> browser<span class="token punctuation">;</span>

  <span class="token comment">// utiliser le système de fichiers pour exposer le wsEndpoint pour les TestEnvironments</span>
  mkdirp<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token constant">DIR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token constant">DIR</span><span class="token punctuation">,</span> <span class="token string">'wsEndpoint'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> browser<span class="token punctuation">.</span><span class="token function">wsEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Nous avons ensuite besoin d'un environnement de test personnalisé pour les marionnettistes</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// puppeteer_environment.js</span>
<span class="token keyword">const</span> NodeEnvironment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jest-environment-node'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> puppeteer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'puppeteer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">DIR</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">tmpdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'jest_puppeteer_global_setup'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">PuppeteerEnvironment</span> <span class="token keyword">extends</span> <span class="token class-name">NodeEnvironment</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// obtenir le wsEndpoint</span>
    <span class="token keyword">const</span> wsEndpoint <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token constant">DIR</span><span class="token punctuation">,</span> <span class="token string">'wsEndpoint'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wsEndpoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'wsEndpoint not found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// se connecter à puppeteer</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>global<span class="token punctuation">.</span>__BROWSER__ <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      browserWSEndpoint<span class="token operator">:</span> wsEndpoint<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">runScript</span><span class="token punctuation">(</span><span class="token parameter">script</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">runScript</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> PuppeteerEnvironment<span class="token punctuation">;</span>
</code></pre></div><p>Enfin, nous pouvons fermer l'instance puppeteer et nettoyer le dossier</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// teardown.js</span>
<span class="token keyword">const</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rimraf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rimraf'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">DIR</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">tmpdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'jest_puppeteer_global_setup'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// fermer l'insstance du navigateur</span>
  <span class="token keyword">await</span> global<span class="token punctuation">.</span>__BROWSER_GLOBAL__<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// nettoyer le fichier wsEndpoint</span>
  rimraf<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token constant">DIR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Avec tout ce qui a été mis en place, nous pouvons maintenant passer nos tests de cette manière :</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// test.js</span>
<span class="token keyword">const</span> timeout <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span>
  <span class="token string">'/ (Home Page)'</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> page<span class="token punctuation">;</span>
    <span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      page <span class="token operator">=</span> <span class="token keyword">await</span> global<span class="token punctuation">.</span>__BROWSER__<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">'https://google.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should load without error'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>textContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span><span class="token string">'google'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  timeout<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Enfin, configurez <code>jest.config.js</code> pour lire ces fichiers. (Le preset <code>jest-puppeteer</code> fait quelque chose comme ça sous le capot).</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  globalSetup<span class="token operator">:</span> <span class="token string">'./setup.js'</span><span class="token punctuation">,</span>
  globalTeardown<span class="token operator">:</span> <span class="token string">'./teardown.js'</span><span class="token punctuation">,</span>
  testEnvironment<span class="token operator">:</span> <span class="token string">'./puppeteer_environment.js'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Voici le code de [exemple de travail complet] (https://github.com/xfumihiro/jest-puppeteer-example).</p> <h1 id="l-utilisation-avec-mongodb"><a href="#l-utilisation-avec-mongodb" class="header-anchor">#</a> L'utilisation avec MongoDB</h1> <p>Avec les API <a href="/jest/Guides/Configuration.html#globalsetup-string">Global Setup/Teardown</a> et <a href="/jest/Guides/Configuration.html#testenvironment-string">Async Test Environment</a>, Jest peut fonctionner sans problème avec <a href="https://www.mongodb.com/" target="_blank" rel="noopener noreferrer">MongoDB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="utiliser-le-prereglage-jest-mongodb"><a href="#utiliser-le-prereglage-jest-mongodb" class="header-anchor">#</a> Utiliser le préréglage jest-mongodb</h2> <p><a href="https://github.com/shelfio/jest-mongodb" target="_blank" rel="noopener noreferrer">Jest MongoDB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> fournit toute la configuration requise pour exécuter vos tests en utilisant MongoDB.</p> <ol><li>Premièrement installer <code>@shelf/jest-mongodb</code></li></ol> <div class="language- extra-class"><pre class="language-text"><code>yarn add @shelf/jest-mongodb --dev
</code></pre></div><ol start="2"><li>Précisez le préréglage dans votre configuration Jest :</li></ol> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;preset&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@shelf/jest-mongodb&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>Ecrire votre test</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>MongoClient<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongodb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'insert'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> connection<span class="token punctuation">;</span>
  <span class="token keyword">let</span> db<span class="token punctuation">;</span>

  <span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    connection <span class="token operator">=</span> <span class="token keyword">await</span> MongoClient<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>__MONGO_URI__<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      useNewUrlParser<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    db <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">db</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>__MONGO_DB_NAME__<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should insert a doc into collection'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> users <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> mockUser <span class="token operator">=</span> <span class="token punctuation">{</span>_id<span class="token operator">:</span> <span class="token string">'some-user-id'</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'John'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> users<span class="token punctuation">.</span><span class="token function">insertOne</span><span class="token punctuation">(</span>mockUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> insertedUser <span class="token operator">=</span> <span class="token keyword">await</span> users<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>_id<span class="token operator">:</span> <span class="token string">'some-user-id'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>insertedUser<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span>mockUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Il n'est pas nécessaire de charger des dépendances.</p> <p>Voir la <a href="https://github.com/shelfio/jest-mongodb" target="_blank" rel="noopener noreferrer">documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> pour plus de details (configuring MongoDB version, etc).</p> <h1 id="l-utilisation-avec-dynamodb"><a href="#l-utilisation-avec-dynamodb" class="header-anchor">#</a> L'utilisation avec DynamoDB</h1> <p>Avec les API <a href="/jest/Guides/Configuration.html#globalsetup-string">Global Setup/Teardown</a> et <a href="/jest/Guides/Configuration.html#testenvironment-string">Async Test Environment</a>, Jest peut fonctionner sans problème avec <a href="https://aws.amazon.com/dynamodb/" target="_blank" rel="noopener noreferrer">DynamoDB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="utilisation-de-jest-dynamodb-preset"><a href="#utilisation-de-jest-dynamodb-preset" class="header-anchor">#</a> Utilisation de  jest-dynamodb Preset</h2> <p><a href="https://github.com/shelfio/jest-dynamodb" target="_blank" rel="noopener noreferrer">Jest DynamoDB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> fournit toute la configuration requise pour effectuer vos tests à l'aide de DynamoDB.</p> <ol><li>Tout d'abord, installez <code>@shelf/jest-dynamodb</code></li></ol> <div class="language- extra-class"><pre class="language-text"><code>yarn add @shelf/jest-dynamodb --dev
</code></pre></div><ol start="2"><li>Specify preset in your Jest configuration:</li></ol> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;preset&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@shelf/jest-dynamodb&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>Créer <code>jest-dynamodb-config.js</code> et définir les tables DynamoDB</li></ol> <p>Voir <a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/DynamoDB.html#createTable-property" target="_blank" rel="noopener noreferrer">Créer une API de table<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  tables<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      TableName<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">files</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      KeySchema<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>AttributeName<span class="token operator">:</span> <span class="token string">'id'</span><span class="token punctuation">,</span> KeyType<span class="token operator">:</span> <span class="token string">'HASH'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      AttributeDefinitions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>AttributeName<span class="token operator">:</span> <span class="token string">'id'</span><span class="token punctuation">,</span> AttributeType<span class="token operator">:</span> <span class="token string">'S'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      ProvisionedThroughput<span class="token operator">:</span> <span class="token punctuation">{</span>ReadCapacityUnits<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> WriteCapacityUnits<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// etc</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ol start="4"><li>Configurer le client DynamoDB</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>DocumentClient<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'aws-sdk/clients/dynamodb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> isTest <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JEST_WORKER_ID</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  convertEmptyValues<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token operator">...</span><span class="token punctuation">(</span>isTest <span class="token operator">&amp;&amp;</span> <span class="token punctuation">{</span>
    endpoint<span class="token operator">:</span> <span class="token string">'localhost:8000'</span><span class="token punctuation">,</span>
    sslEnabled<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    region<span class="token operator">:</span> <span class="token string">'local-env'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ddb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DocumentClient</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="5"><li>Ecrire les tests</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should insert item into table'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> ddb
    <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>TableName<span class="token operator">:</span> <span class="token string">'files'</span><span class="token punctuation">,</span> Item<span class="token operator">:</span> <span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span> hello<span class="token operator">:</span> <span class="token string">'world'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span>Item<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> ddb<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">{</span>TableName<span class="token operator">:</span> <span class="token string">'files'</span><span class="token punctuation">,</span> Key<span class="token operator">:</span> <span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>Item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
    hello<span class="token operator">:</span> <span class="token string">'world'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Il n'est pas nécessaire de charger des dépendances.</p> <p>Voir <a href="https://github.com/shelfio/jest-dynamodb" target="_blank" rel="noopener noreferrer">documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> pour les détails.</p> <p>Manipulation du DOM</p> <p>Une autre classe de fonctions souvent considérée comme difficile à tester est le code qui manipule directement le DOM. Voyons comment nous pouvons tester l'extrait suivant de code jQuery qui écoute un événement de clic, récupère certaines données de manière asynchrone et définit le contenu d'un span.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// displayUser.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> $ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jquery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fetchCurrentUser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./fetchCurrentUser.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token function">fetchCurrentUser</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">const</span> loggedText <span class="token operator">=</span> <span class="token string">'Logged '</span> <span class="token operator">+</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>loggedIn <span class="token operator">?</span> <span class="token string">'In'</span> <span class="token operator">:</span> <span class="token string">'Out'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#username'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>fullName <span class="token operator">+</span> <span class="token string">' - '</span> <span class="token operator">+</span> loggedText<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Là encore, nous créons un fichier test dans le dossier <code>__tests__/</code> :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// __tests__/displayUser-test.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">'../fetchCurrentUser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'displays a user after a click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token comment">// Mettre en place notre corps de documents</span>
 document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span>
   <span class="token string">'&lt;div&gt;'</span> <span class="token operator">+</span>
   <span class="token string">'  &lt;span id=&quot;username&quot; /&gt;'</span> <span class="token operator">+</span>
   <span class="token string">'  &lt;button id=&quot;button&quot; /&gt;'</span> <span class="token operator">+</span>
   <span class="token string">'&lt;/div&gt;'</span><span class="token punctuation">;</span>

 <span class="token comment">// Ce module a un effet secondaire</span>
 <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../displayUser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">const</span> $ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jquery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">const</span> fetchCurrentUser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../fetchCurrentUser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// Dites à la fonction fictive fetchCurrentUser d'invoquer automatiquement</span>
 <span class="token comment">// son rappel avec quelques données</span>
 fetchCurrentUser<span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
     fullName<span class="token operator">:</span> <span class="token string">'Johnny Cash'</span><span class="token punctuation">,</span>
     loggedIn<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// Utiliser jquery pour émuler un clic sur notre bouton</span>
 <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// affirment que la fonction fetchCurrentUser a été appelée, et que la</span>
 <span class="token comment">// Le texte intérieur de #username span a été mis à jour comme on pouvait s'y attendre.</span>
 <span class="token function">expect</span><span class="token punctuation">(</span>fetchCurrentUser<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#username'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'Johnny Cash - Logged In'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>La fonction testée ajoute un auditeur d'événements sur l'élément DOM &quot;#button&quot;, nous devons donc configurer correctement notre DOM pour le test. Jest est livré avec <code>jsdom</code> qui simule un environnement DOM comme si vous étiez dans le navigateur. Cela signifie que chaque API DOM que nous appelons peut être observée de la même manière qu'elle le serait dans un navigateur !</p> <p>Nous allons simuler <code>fetchCurrentUser.js</code> afin que notre test ne fasse pas une vraie requête de réseau mais qu'il se résolve plutôt à simuler des données localement. Cela garantit que notre test peut se terminer en quelques millisecondes plutôt qu'en quelques secondes et garantit une vitesse d'itération de test unitaire rapide.</p> <p>Le code de cet exemple est disponible à l'adresse <a href="https://github.com/facebook/jest/tree/master/examples/jquery" target="_blank" rel="noopener noreferrer">examples/jquery<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h1 id="les-plugins-de-surveillances"><a href="#les-plugins-de-surveillances" class="header-anchor">#</a> Les plugins de surveillances</h1> <p>Le système de plugin de montre Jest permet de se connecter à des parties spécifiques de Jest et de définir des invites de menu en mode montre qui exécutent le code sur simple pression d'une touche. Combinées, ces fonctionnalités vous permettent de développer des expériences interactives adaptées à votre flux de travail.</p> <h2 id="watch-plugin-interface"><a href="#watch-plugin-interface" class="header-anchor">#</a> Watch Plugin Interface</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">MyWatchPlugin</span> <span class="token punctuation">{</span>
  <span class="token comment">// Ajouter des crochets aux événements du cycle de vie des Jest</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">jestHooks</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// Obtenez les informations nécessaires pour les plugins interactifs</span>
  <span class="token function">getUsageInfo</span><span class="token punctuation">(</span><span class="token parameter">globalConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// Exécuté lorsque la clé de `getUsageInfo` est entrée</span>
  <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">globalConfig<span class="token punctuation">,</span> updateConfigAndRun</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="hooking-into-jest"><a href="#hooking-into-jest" class="header-anchor">#</a> Hooking into Jest</h2> <p>Pour connecter votre watch plugin à Jest, ajoutez son chemin sous <code>watchPlugins</code> dans votre configuration Jest :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// jest.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  watchPlugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'path/to/yourWatchPlugin'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Des plugins de surveillance personnalisés peuvent ajouter des accroches aux événements de Jest. Ces accroches peuvent être ajoutées avec ou sans clé interactive dans le menu du mode montre.</p> <h3 id="apply-jesthooks"><a href="#apply-jesthooks" class="header-anchor">#</a> <code>apply(jestHooks)</code></h3> <p>Des crochets de bouffon peuvent être attachés en appliquant la méthode &quot;Appliquer&quot;. Cette méthode reçoit un argument &quot;jestHooks&quot; qui permet au plugin de s'accrocher à des parties spécifiques du cycle de vie d'un test.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">MyWatchPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">jestHooks</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Vous trouverez ci-dessous les crochets disponibles dans Jest.</p> <h4 id="jesthooks-shouldruntestsuite-testsuiteinfo"><a href="#jesthooks-shouldruntestsuite-testsuiteinfo" class="header-anchor">#</a> <code>jestHooks.shouldRunTestSuite(testSuiteInfo)</code></h4> <p>Renvoie un booléen (ou <code>Promise&lt;boolean&gt;</code> pour la gestion des opérations asynchrones) pour spécifier si un test doit être exécuté ou non.</p> <p>Par exemple :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">MyWatchPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">jestHooks</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jestHooks<span class="token punctuation">.</span><span class="token function">shouldRunTestSuite</span><span class="token punctuation">(</span><span class="token parameter">testSuiteInfo</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> testSuiteInfo<span class="token punctuation">.</span>testPath<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'my-keyword'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// or a promise</span>
    jestHooks<span class="token punctuation">.</span><span class="token function">shouldRunTestSuite</span><span class="token punctuation">(</span><span class="token parameter">testSuiteInfo</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>testSuiteInfo<span class="token punctuation">.</span>testPath<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'my-keyword'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="jesthooks-ontestruncomplete-results"><a href="#jesthooks-ontestruncomplete-results" class="header-anchor">#</a> <code>jestHooks.onTestRunComplete(results)</code></h4> <p>Il est appelé à la fin de chaque essai. Il a les résultats des tests comme argument.</p> <p>Par exemple :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">MyWatchPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">jestHooks</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jestHooks<span class="token punctuation">.</span><span class="token function">onTestRunComplete</span><span class="token punctuation">(</span><span class="token parameter">results</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_hasSnapshotFailure <span class="token operator">=</span> results<span class="token punctuation">.</span>snapshot<span class="token punctuation">.</span>failure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="jesthooks-onfilechange-projects"><a href="#jesthooks-onfilechange-projects" class="header-anchor">#</a> <code>jestHooks.onFileChange({projects})</code></h4> <p>Est appelé chaque fois qu'il y a un changement dans le système de fichiers</p> <ul><li><code>projects: Array&lt;config: ProjectConfig, testPaths: Array&lt;string&gt;</code>: Comprend tous les parcours de test que Jest surveille.</li></ul> <p>Par exemple :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">MyWatchPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">jestHooks</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jestHooks<span class="token punctuation">.</span><span class="token function">onFileChange</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>projects<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_projects <span class="token operator">=</span> projects<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="watch-menu-integration"><a href="#watch-menu-integration" class="header-anchor">#</a> Watch Menu Integration</h2> <p>Les plugins de surveillance personnalisés peuvent également ajouter ou remplacer des fonctionnalités au menu de surveillance en spécifiant une paire clé/guide dans la méthode &quot;GetUsageInfo&quot; et une méthode &quot;Run&quot; pour l'exécution de la clé.</p> <h3 id="getusageinfo-globalconfig"><a href="#getusageinfo-globalconfig" class="header-anchor">#</a> <code>getUsageInfo(globalConfig)</code></h3> <p>Pour ajouter une clé au menu de surveillance, implémentez la méthode &quot;getUsageInfo&quot;, en retournant une clé et l'invite :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">MyWatchPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">getUsageInfo</span><span class="token punctuation">(</span><span class="token parameter">globalConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      key<span class="token operator">:</span> <span class="token string">'s'</span><span class="token punctuation">,</span>
      prompt<span class="token operator">:</span> <span class="token string">'do something'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Cela ajoutera une ligne dans le menu du mode surveillance <em>(<code>› Press s to do something.</code>)</em></p> <div class="language-text extra-class"><pre class="language-text"><code>Watch Usage
 › Press p to filter by a filename regex pattern.
 › Press t to filter by a test name regex pattern.
 › Press q to quit watch mode.
 › Press s to do something. // &lt;-- This is our plugin
 › Press Enter to trigger a test run.
</code></pre></div><p><strong>Note</strong>: Si la clé de votre plugin existe déjà en tant que clé par défaut, votre plugin remplacera cette clé.</p> <h3 id="run-globalconfig-updateconfigandrun"><a href="#run-globalconfig-updateconfigandrun" class="header-anchor">#</a> <code>run(globalConfig, updateConfigAndRun)</code></h3> <p>Pour gérer les événements de pression de la touche retournée par &quot;GetUsageInfo&quot;, vous pouvez implémenter la méthode &quot;run&quot;. Cette méthode renvoie un <code>Promise&lt;boolean&gt;</code> qui peut être résolu lorsque le plugin veut renvoyer le contrôle à Jest. Le &quot;booléen&quot; spécifie si Jest doit relancer les tests après avoir récupéré le contrôle.</p> <ul><li><code>globalConfig</code>: Une représentation de la configuration globale actuelle de Jest</li> <li><code>updateConfigAndRun</code>: Permet de déclencher un essai pendant que le plugin interactif est en cours d'exécution.</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">MyWatchPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">globalConfig<span class="token punctuation">,</span> updateConfigAndRun</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Faire quelque chose.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Note</strong>: Si vous appelez <code>updateConfigAndRun</code>, votre méthode <code>run</code> ne devrait pas se résoudre à une valeur de vérité, car cela déclencherait une double exécution.</p> <h4 id="authorized-configuration-keys"><a href="#authorized-configuration-keys" class="header-anchor">#</a> Authorized configuration keys</h4> <p>Pour des raisons de stabilité et de sécurité, seule une partie des clés de configuration globale peut être mise à jour avec <code>updateConfigAndRun</code>. La liste blanche actuelle est la suivante :</p> <ul><li><a href="/jest/Guides/configuration.html#bail-number--boolean"><code>bail</code></a></li> <li><a href="/jest/Guides/cli.html#--changedsince"><code>changedSince</code></a></li> <li><a href="/jest/Guides/configuration.html#collectcoverage-boolean"><code>collectCoverage</code></a></li> <li><a href="/jest/Guides/configuration.html#collectcoveragefrom-array"><code>collectCoverageFrom</code></a></li> <li><a href="/jest/Guides/configuration.html#collectcoverageonlyfrom-array"><code>collectCoverageOnlyFrom</code></a></li> <li><a href="/jest/Guides/configuration.html#coveragedirectory-string"><code>coverageDirectory</code></a></li> <li><a href="/jest/Guides/configuration.html#coveragereporters-arraystring"><code>coverageReporters</code></a></li> <li><a href="/jest/Guides/configuration.html#notify-boolean"><code>notify</code></a></li> <li><a href="/jest/Guides/configuration.html#notifymode-string"><code>notifyMode</code></a></li> <li><a href="/jest/Guides/configuration.html#onlyfailures-boolean"><code>onlyFailures</code></a></li> <li><a href="/jest/Guides/configuration.html#reporters-arraymodulename--modulename-options"><code>reporters</code></a></li> <li><a href="/jest/Guides/cli.html#--testnamepatternregex"><code>testNamePattern</code></a></li> <li><a href="/jest/Guides/cli.html#--testpathpatternregex"><code>testPathPattern</code></a></li> <li><a href="/jest/Guides/cli.html#--updatesnapshot"><code>updateSnapshot</code></a></li> <li><a href="/jest/Guides/configuration.html#verbose-boolean"><code>verbose</code></a></li></ul> <h2 id="customization"><a href="#customization" class="header-anchor">#</a> Customization</h2> <p>Les plugins peuvent être personnalisés via votre configuration Jest.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// jest.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  watchPlugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
      <span class="token string">'path/to/yourWatchPlugin'</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        key<span class="token operator">:</span> <span class="token string">'k'</span><span class="token punctuation">,</span> <span class="token comment">// &lt;- your custom key</span>
        prompt<span class="token operator">:</span> <span class="token string">'show a custom prompt'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Noms de configuration recommandés :</p> <ul><li><code>key</code>: Modifie la clé du plugin.</li> <li><code>prompt</code>: Permet à l'utilisateur de personnaliser le texte dans l'invite du plugin.</li></ul> <p>Si l'utilisateur a fourni une configuration personnalisée, celle-ci sera passée en argument au constructeur du plugin.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">MyWatchPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>config<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="choisir-une-bonne-cle"><a href="#choisir-une-bonne-cle" class="header-anchor">#</a> Choisir une bonne clé</h2> <p>Jest permet à des plugins tiers de passer outre certaines de ses touches de fonction intégrées, mais pas toutes. Plus précisément, les touches suivantes sont <strong>non écrasables</strong> :</p> <ul><li><code>c</code> (efface les modèles de filtre)</li> <li><code>i</code> (mise à jour interactives des instantanés non concordants)</li> <li><code>q</code> (quitte)</li> <li><code>u</code> (met à jour tous les instantanés non concordants)</li> <li><code>w</code> (affiche l'utilisation du mode veille / les actions disponibles)</li></ul> <p>Les touches suivantes pour les fonctionnalités intégrées <strong>peuvent être écrasées</strong> :</p> <ul><li><code>p</code> (test du modèle de nom de fichier)</li> <li><code>t</code> (nom du modèle de test)</li></ul> <p>Toute clé non utilisée par la fonctionnalité intégrée peut être réclamée, comme vous pouvez vous y attendre. Essayez d'éviter d'utiliser des touches qui sont difficiles à obtenir sur divers claviers (par exemple &quot;é&quot;, &quot;€&quot;), ou qui ne sont pas visibles par défaut (par exemple, de nombreux claviers Mac n'ont pas d'indices visuels pour les caractères tels que &quot;<code>|</code>, <code>\</code>, <code>[</code>, etc.</p> <h3 id="quand-un-conflit-survient"><a href="#quand-un-conflit-survient" class="header-anchor">#</a> Quand un conflit survient</h3> <p>Si votre plugin tente d'écraser une clé réservée, Jest fera une erreur en affichant un message descriptif, par exemple :</p> <blockquote><p>Watch plugin YourFaultyPlugin a tenté d'enregistrer la clé &quot;q&quot;, qui est réservée en interne pour quitter le mode surveillance. Veuillez changer la clé de configuration pour ce plugin.</p></blockquote> <p>Il est également interdit aux plugins tiers d'écraser une clé déjà réservée par un autre plugin tiers présent plus tôt dans la liste des plugins configurés (paramètre de tableau <code>watchPlugins</code>). Lorsque cela se produit, vous recevez également un message d'erreur qui tente de vous aider à corriger ce problème :</p> <blockquote><p>Watch plugins YourFaultyPlugin et TheirFaultyPlugin ont tous deux tenté d'enregistrer la clé <code>x</code>. Veuillez modifier la configuration de la clé pour l'un des plugins en conflit afin d'éviter tout chevauchement.</p></blockquote> <h1 id="migrer-vers-jest"><a href="#migrer-vers-jest" class="header-anchor">#</a> Migrer vers jest</h1> <p>Si vous souhaitez essayer Jest avec une base de code existante, il y a plusieurs façons de le convertir à Jest :</p> <ul><li>Si vous utilisez Jasmine, ou une API similaire à Jasmine (par exemple <a href="https://mochajs.org" target="_blank" rel="noopener noreferrer">Mocha<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>), Jest devrait être compatible dans la plupart des cas, ce qui rend la migration moins compliquée.</li> <li>Si vous utilisez AVA, Expect.js (par Automattic), Jasmine, Mocha, proxyquire, Should.js ou Tape, vous pouvez migrer automatiquement avec les codemods Jest (voir ci-dessous).</li> <li>Si vous aimez <a href="http://chaijs.com/" target="_blank" rel="noopener noreferrer">chai<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, vous pouvez passer à Jest et continuer à utiliser chai. Cependant, nous vous recommandons d'essayer les assertions de Jest et leurs messages d'échec. Les Codemods de Jest peuvent migrer depuis chai (voir ci-dessous).</li></ul> <h2 id="jest-codemods"><a href="#jest-codemods" class="header-anchor">#</a> jest-codemods</h2> <p>Si vous utilisez <a href="https://github.com/avajs/ava" target="_blank" rel="noopener noreferrer">AVA<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://github.com/chaijs/chai" target="_blank" rel="noopener noreferrer">Chai<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://github.com/Automattic/expect.js" target="_blank" rel="noopener noreferrer">Expect.js (by Automattic)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://github.com/jasmine/jasmine" target="_blank" rel="noopener noreferrer">Jasmine<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://github.com/mochajs/mocha" target="_blank" rel="noopener noreferrer">Mocha<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://github.com/thlorenz/proxyquire" target="_blank" rel="noopener noreferrer">proxyquire<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://github.com/shouldjs/should.js" target="_blank" rel="noopener noreferrer">Should.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ou <a href="https://github.com/substack/tape" target="_blank" rel="noopener noreferrer">Tape<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, vous pouvez utiliser les <a href="https://github.com/skovhus/jest-codemods" target="_blank" rel="noopener noreferrer">jest-codemods<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> tiers pour effectuer la plupart des travaux de migration. Il exécute une transformation de code sur votre base de code en utilisant <a href="https://github.com/facebook/jscodeshift" target="_blank" rel="noopener noreferrer">jscodeshift<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Pour transformer vos tests existants, naviguez jusqu'au projet contenant les tests et exécutez :</p> <h1 id="troubleshooting"><a href="#troubleshooting" class="header-anchor">#</a> Troubleshooting</h1> <p>Euh oh, quelque chose a mal tourné ? Utilisez ce guide pour résoudre les problèmes avec Jest.</p> <h2 id="les-tests-echouent-et-vous-ne-savez-pas-pourquoi"><a href="#les-tests-echouent-et-vous-ne-savez-pas-pourquoi" class="header-anchor">#</a> Les tests échouent et vous ne savez pas pourquoi</h2> <p>Essayez d'utiliser le support de débogage intégré à Node. Note : Cela ne fonctionnera que dans Node.js 8+.</p> <p>Placez une instruction <code>debugger;</code> dans l'un de vos tests, puis, dans le répertoire de votre projet, lancez :</p> <div class="language-bash extra-class"><pre class="language-bash"><code>node --inspect-brk node_modules/.bin/jest --runInBand <span class="token punctuation">[</span>any other arguments here<span class="token punctuation">]</span>
or on Windows
node --inspect-brk ./node_modules/jest/bin/jest.js --runInBand <span class="token punctuation">[</span>any other arguments here<span class="token punctuation">]</span>
</code></pre></div><p>Jest fonctionnera ainsi dans un processus Node auquel un débogueur externe pourra se connecter. Notez que le processus s'arrêtera jusqu'à ce que le débogueur s'y connecte.</p> <p>Pour déboguer dans Google Chrome (ou tout autre navigateur basé sur Chromium), ouvrez votre navigateur et allez dans <code>chrome://inspect</code> et cliquez sur &quot;Open Dedicated DevTools for Node&quot;, ce qui vous donnera une liste des instances de nœuds disponibles auxquelles vous pouvez vous connecter. Cliquez sur l'adresse affichée dans le terminal (généralement quelque chose comme <code>localhost:9229</code>) après avoir exécuté la commande ci-dessus, et vous pourrez déboguer Jest en utilisant les DevTools de Chrome.</p> <p>Les outils de développement Chrome seront affichés et un point d'arrêt sera fixé à la première ligne du script CLI de Jest (ceci est fait pour vous donner le temps d'ouvrir les outils de développement et pour empêcher que Jest ne s'exécute avant que vous n'ayez le temps de le faire). Cliquez sur le bouton qui ressemble à un bouton &quot;play&quot; en haut à droite de l'écran pour continuer l'exécution. Lorsque Jest exécute le test qui contient l'instruction <code>debugger</code>, l'exécution s'arrête et vous pouvez examiner la portée actuelle et la pile d'appels.</p> <blockquote><p>Note : l'option <code>--runInBand</code> cli permet de s'assurer que Jest exécute le test dans le même processus plutôt que d'engendrer des processus pour des tests individuels. Normalement, Jest parallélise les tests entre les processus, mais il est difficile de déboguer plusieurs processus en même temps.</p></blockquote> <h2 id="debugger-dans-vs-code"><a href="#debugger-dans-vs-code" class="header-anchor">#</a> Débugger dans VS Code</h2> <p>Il existe plusieurs façons de déboguer les tests Jest avec le <a href="https://code.visualstudio.com" target="_blank" rel="noopener noreferrer">code de Visual Studio<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> intégré au <a href="https://code.visualstudio.com/docs/nodejs/nodejs-debugging" target="_blank" rel="noopener noreferrer">débogueur<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Pour attacher le débogueur intégré, effectuez vos tests comme indiqué ci-dessus :</p> <div class="language-bash extra-class"><pre class="language-bash"><code>node --inspect-brk node_modules/.bin/jest --runInBand <span class="token punctuation">[</span>any other arguments here<span class="token punctuation">]</span>
or on Windows
node --inspect-brk ./node_modules/jest/bin/jest.js --runInBand <span class="token punctuation">[</span>any other arguments here<span class="token punctuation">]</span>
</code></pre></div><p>Attachez ensuite le débogueur de VS Code en utilisant la configuration suivante <code>launch.json</code> :</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.2.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;request&quot;</span><span class="token operator">:</span> <span class="token string">&quot;attach&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Attach&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">9229</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Pour lancer et joindre automatiquement un processus exécutant vos tests, utilisez la configuration suivante :</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.2.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Debug Jest Tests&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;request&quot;</span><span class="token operator">:</span> <span class="token string">&quot;launch&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;runtimeArgs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;--inspect-brk&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;${workspaceRoot}/node_modules/.bin/jest&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;--runInBand&quot;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;console&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integratedTerminal&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;internalConsoleOptions&quot;</span><span class="token operator">:</span> <span class="token string">&quot;neverOpen&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">9229</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ou le code suivant pour Windows :</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.2.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Debug Jest Tests&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;request&quot;</span><span class="token operator">:</span> <span class="token string">&quot;launch&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;runtimeArgs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;--inspect-brk&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;${workspaceRoot}/node_modules/jest/bin/jest.js&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;--runInBand&quot;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;console&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integratedTerminal&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;internalConsoleOptions&quot;</span><span class="token operator">:</span> <span class="token string">&quot;neverOpen&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">9229</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Si vous utilisez la <a href="https://github.com/facebookincubator/create-react-app" target="_blank" rel="noopener noreferrer"><code>create-react-app</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> de Facebook, vous pouvez déboguer vos tests Jest avec la configuration suivante :</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.2.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Debug CRA Tests&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;request&quot;</span><span class="token operator">:</span> <span class="token string">&quot;launch&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;runtimeExecutable&quot;</span><span class="token operator">:</span> <span class="token string">&quot;${workspaceRoot}/node_modules/.bin/react-scripts&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--runInBand&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--no-cache&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--env=jsdom&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;cwd&quot;</span><span class="token operator">:</span> <span class="token string">&quot;${workspaceRoot}&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;inspector&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;console&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integratedTerminal&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;internalConsoleOptions&quot;</span><span class="token operator">:</span> <span class="token string">&quot;neverOpen&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Vous trouverez de plus amples informations sur le débogage des nœuds <a href="https://nodejs.org/api/debugger.html" target="_blank" rel="noopener noreferrer">ici<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="debugger-dans-webstorm"><a href="#debugger-dans-webstorm" class="header-anchor">#</a> Débugger dans WebStorm</h2> <p>La façon la plus simple de déboguer les tests Jest dans <a href="https://www.jetbrains.com/webstorm/" target="_blank" rel="noopener noreferrer">WebStorm<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> est d'utiliser la configuration &quot;Jest run/debug&quot;. Il lancera les tests et attachera automatiquement le débogueur.</p> <p>Dans le menu WebStorm &quot;Run&quot;, sélectionnez &quot;Edit Configurations...&quot;. Ensuite, cliquez sur &quot;+&quot; et sélectionnez &quot;Jest&quot;. Spécifiez éventuellement le fichier de configuration Jest, les options supplémentaires et les variables d'environnement. Sauvegardez la configuration, mettez les points d'arrêt dans le code, puis cliquez sur l'icône verte de débogage pour commencer le débogage.</p> <p>Si vous utilisez la [<code>create-react-app</code>] (https://github.com/facebookincubator/create-react-app) de Facebook, dans la configuration de Jest run/debug, indiquez le chemin du paquet <code>react-scripts</code> dans le champ du paquet Jest et ajoutez <code>--env=jsdom</code> au champ des options de Jest.</p> <h2 id="question-de-mis-en-cache"><a href="#question-de-mis-en-cache" class="header-anchor">#</a> Question de mis en cache</h2> <p>Le script de transformation a été modifié ou Babel a été mis à jour et les changements ne sont pas reconnus par Jest ?</p> <p>Réessayez avec <a href="/jest/Guides/CLI.html#--cache"><code>--no-cache</code></a>. Jest caches a transformé les fichiers des modules pour accélérer l'exécution des tests. Si vous utilisez votre propre transformateur personnalisé, pensez à y ajouter une fonction <code>getCacheKey</code> : <a href="https://github.com/facebook/relay/blob/58cf36c73769690f0bbf90562707eadb062b029d/scripts/jest/preprocessor.js#L56-L61" target="_blank" rel="noopener noreferrer">getCacheKey in Relay<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="promesses-non-tenues"><a href="#promesses-non-tenues" class="header-anchor">#</a> Promesses non tenues</h2> <p>Si une promesse ne se concrétise pas du tout, cette erreur risque d'être rejetée :</p> <div class="language-bash extra-class"><pre class="language-bash"><code>- Error: Timeout - Async callback was not invoked within <span class="token function">timeout</span> specified by jasmine.DEFAULT_TIMEOUT_INTERVAL.`
</code></pre></div><p>Le plus souvent, cela est dû à des mises en œuvre contradictoires de la Promesse. Envisagez de remplacer la mise en œuvre globale de Promise par votre propre mise en œuvre, par exemple <code>global.Promise = jest.requireActual('promise');</code> et/ou consolidez les bibliothèques Promise utilisées en une seule.</p> <p>Si votre test est long, vous pouvez envisager d'augmenter le délai d'attente en appelant &quot;jest.setTimeout&quot;.</p> <div class="language-js extra-class"><pre class="language-js"><code>jest<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10 second timeout</span>
</code></pre></div><h2 id="questions-relatives-aux-gardiens"><a href="#questions-relatives-aux-gardiens" class="header-anchor">#</a> Questions relatives aux gardiens</h2> <p>Essayez de lancer Jest avec <a href="/jest/Guides/CLI.html#--watchman"><code>--no-watchman</code></a> ou mettez l'option de configuration <code>watchman</code> à <code>false</code>.</p> <p>Voir également <a href="https://facebook.github.io/watchman/docs/troubleshooting" target="_blank" rel="noopener noreferrer">watchman troubleshooting<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="les-tests-sont-extremement-lents-sur-le-serveur-docker-et-ou-d-integration-continue-ic"><a href="#les-tests-sont-extremement-lents-sur-le-serveur-docker-et-ou-d-integration-continue-ic" class="header-anchor">#</a> Les tests sont extrêmement lents sur le serveur Docker et/ou d'intégration continue (IC).</h2> <p>Bien que Jest soit la plupart du temps extrêmement rapide sur les ordinateurs modernes multicœurs dotés de SSD rapides, il peut être lent sur certaines configurations, comme l'ont découvert nos utilisateurs (https://github.com/facebook/jest/issues/1395) (https://github.com/facebook/jest/issues/1524#issuecomment-260246008).</p> <p>Sur la base des <a href="https://github.com/facebook/jest/issues/1524#issuecomment-262366820" target="_blank" rel="noopener noreferrer">conclusions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, une façon d'atténuer ce problème et d'améliorer la vitesse de 50% est d'effectuer des tests de manière séquentielle.</p> <p>Pour ce faire, vous pouvez effectuer des tests dans le même fil en utilisant <a href="/jest/Guides/CLI.html#--runinband"><code>--runInBand</code></a> :</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Utilisation de Jest CLI</span>
jest --runInBand

<span class="token comment"># Utilisation du test yark (e.g. with create-react-app)</span>
<span class="token function">yarn</span> <span class="token builtin class-name">test</span> --runInBand
</code></pre></div><p>Une autre solution pour accélérer le temps d'exécution des tests sur les serveurs d'intégration continue tels que Travis-CI consiste à fixer le nombre maximum de travailleurs à ~<em>4</em>. Sur Travis-CI en particulier, cela peut réduire de moitié le temps d'exécution des tests. Note : Le plan Travis CI <em>libre</em> disponible pour les projets open source ne comprend que 2 cœurs de processeur.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Utilisation de Jest CLI</span>
jest --maxWorkers<span class="token operator">=</span><span class="token number">4</span>

<span class="token comment"># Utilisation du test yarn (e.g. with create-react-app)</span>
<span class="token function">yarn</span> <span class="token builtin class-name">test</span> --maxWorkers<span class="token operator">=</span><span class="token number">4</span>
</code></pre></div><h2 id="coveragepathignorepatterns-semble-n-avoir-aucun-effet"><a href="#coveragepathignorepatterns-semble-n-avoir-aucun-effet" class="header-anchor">#</a> <code>coveragePathIgnorePatterns</code> semble n'avoir aucun effet.</h2> <p>Assurez-vous que vous n'utilisez pas le plugin <code>babel-plugin-istanbul</code>. Jest enveloppe Istanbul, et donc dit aussi à Istanbul quels fichiers à instrumenter avec la collection de couverture. Lorsque vous utilisez le plugin <code>Babel-plugin-istanbul</code>, chaque fichier qui est traité par Babel aura un code de collecte de couverture, et ne sera donc pas ignoré par les <code>coveragePathIgnorePatterns</code>.</p> <h2 id="definir-les-tests"><a href="#definir-les-tests" class="header-anchor">#</a> Définir les tests</h2> <p>Les tests doivent être définis de manière synchrone pour que Jest puisse collecter vos tests.</p> <p>À titre d'exemple pour montrer pourquoi c'est le cas, imaginez que nous écrivions un test comme ça :</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Don't do this it will not work</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'passes'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Lorsque Jest exécute votre test pour collecter les <code>tests</code>, il n'en trouvera aucun parce que nous avons réglé la définition pour qu'elle se produise de manière asynchrone à la prochaine coche de la boucle d'événement.</p> <p>Note : Cela signifie que lorsque vous utilisez <code>test.each</code>, vous ne pouvez pas définir la table de manière asynchrone dans un <code>beforeEach</code> / <code>beforeAll</code>.</p> <h2 id="toujours-pas-resolu"><a href="#toujours-pas-resolu" class="header-anchor">#</a> Toujours pas résolu ?</h2> <p>Voir <a href="/help.html">Aide</a>.</p> <h1 id="architecture"><a href="#architecture" class="header-anchor">#</a> Architecture</h1> <p>Si vous souhaitez en savoir plus sur le fonctionnement de Jest, sur l'architecture du cadre et sur la manière dont Jest est divisé en paquets individuels réutilisables, regardez cette vidéo :</p> <iframe width="560" height="315" src="https://www.youtube.com/embed/3YDiloj8_d0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen"></iframe></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1dfb11b9.js" defer></script><script src="/assets/js/2.76e9c098.js" defer></script><script src="/assets/js/26.6c0a0e32.js" defer></script>
  </body>
</html>
